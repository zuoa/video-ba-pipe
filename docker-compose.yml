version: '3.8'

services:
   # ============================================
  # CPU版本服务
  # ============================================
  video-ba-pipe-cpu:
    image: ghcr.io/zuoa/video-ba-pipe:cpu
    container_name: video-ba-pipe-cpu
    restart: unless-stopped
    shm_size: '8gb'
    
    # 环境变量
    environment:
      - DB_PATH=/data/db/ba.db
      - FRAME_SAVE_PATH=/data/frames
      - VIDEO_SAVE_PATH=/data/videos
      - VIDEO_SOURCE_PATH=/data/video_sources
      - MODEL_SAVE_PATH=/data/models
      - SNAPSHOT_PATH=/data/snapshots
      - SNAPSHOT_ENABLED=true
      - SNAPSHOT_INTERVAL=60
      - IS_EXTREME_DECODE_MODE=false
      - RECORDING_ENABLED=true
      - PRE_ALERT_DURATION=30
      - POST_ALERT_DURATION=30
      - RECORDING_FPS=10
      - RINGBUFFER_DURATION=60
      - ALERT_SUPPRESSION_DURATION=60
      - RABBITMQ_ENABLED=true
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=admin
      - RABBITMQ_PASSWORD=admin123
      - RABBITMQ_VHOST=/
      - RABBITMQ_ALERT_QUEUE=video_alerts
      - RABBITMQ_ALERT_EXCHANGE=video_alerts
      - RABBITMQ_ALERT_ROUTING_KEY=alert
    
    # 数据卷挂载
    volumes:
      - ./data:/data
    
    # 端口映射 (使用不同端口避免冲突)
    ports:
      - "5001:5000"
    
    # 网络配置
    networks:
      - video-ba-network
    
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # 性能优化建议
    # CPU版本可能需要限制资源使用
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4'
    #       memory: 8G

networks:
  video-ba-network:
    driver: bridge

