{% extends "base.html" %}

{% block title %}å·¥ä½œæµç®¡ç†{% endblock %}
{% block page_title %}å·¥ä½œæµç®¡ç†{% endblock %}
{% block page_subtitle %}å¯è§†åŒ–é…ç½®è§†é¢‘åˆ†æå·¥ä½œæµ{% endblock %}

{% block content %}
<div class="max-w-full mx-auto">
    <!-- å·¥ä½œæµåˆ—è¡¨ -->
    <div id="workflowList" class="mb-6">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-black rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-project-diagram text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">å·¥ä½œæµåˆ—è¡¨</h3>
                    <p class="text-sm text-gray-500" id="workflowCount">å…± 0 ä¸ªå·¥ä½œæµ</p>
                </div>
            </div>
            <button onclick="showCreateModal()" class="btn-primary text-white px-6 py-3 rounded-lg font-medium shadow-lg flex items-center space-x-2 hover:shadow-xl">
                <i class="fas fa-plus"></i>
                <span>æ–°å»ºå·¥ä½œæµ</span>
            </button>
        </div>

        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="min-w-full divide-y divide-gray-100">
                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">åç§°</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">æè¿°</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">çŠ¶æ€</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">æ›´æ–°æ—¶é—´</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="workflowsTable" class="bg-white divide-y divide-gray-100">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»º/ç¼–è¾‘å·¥ä½œæµæ¨¡æ€æ¡† -->
<div id="workflowModal" class="hidden fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
    <div class="relative top-10 mx-auto p-8 border border-gray-200 w-11/12 md:w-1/2 shadow-2xl rounded-2xl bg-white">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800" id="modalTitle">æ–°å»ºå·¥ä½œæµ</h3>
            <button onclick="closeWorkflowModal()" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg p-2 transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <form id="workflowForm" onsubmit="handleWorkflowSubmit(event)" class="space-y-6">
            <input type="hidden" id="workflowId">
            
            <div>
                <label class="block text-gray-700 text-sm font-semibold mb-2">å·¥ä½œæµåç§° *</label>
                <input type="text" id="workflowName" required placeholder="ä¾‹å¦‚: é—¨å£ç›‘æ§å·¥ä½œæµ"
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all">
            </div>

            <div>
                <label class="block text-gray-700 text-sm font-semibold mb-2">æè¿°</label>
                <textarea id="workflowDescription" rows="3" placeholder="æè¿°å·¥ä½œæµçš„ç”¨é€”"
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all"></textarea>
            </div>

            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-100">
                <button type="button" onclick="closeWorkflowModal()" class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl transition-all">
                    å–æ¶ˆ
                </button>
                <button type="submit" class="px-6 py-3 btn-primary text-white font-medium rounded-xl shadow-lg">
                    <i class="fas fa-check mr-2"></i>åˆ›å»ºå¹¶ç¼–è¾‘
                </button>
            </div>
        </form>
    </div>
</div>

<!-- å·¥ä½œæµç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
<div id="editorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 overflow-hidden h-full w-full z-50">
    <div class="relative w-full h-full bg-white">
        <!-- ç¼–è¾‘å™¨å¤´éƒ¨ -->
        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-gray-800 to-black text-white shadow-lg">
            <div class="flex items-center space-x-4">
                <i class="fas fa-project-diagram text-2xl"></i>
                <div>
                    <h3 class="text-xl font-bold" id="editorTitle">å·¥ä½œæµç¼–è¾‘å™¨</h3>
                    <p class="text-sm text-gray-300" id="editorSubtitle">æ‹–æ‹½ç»„ä»¶åˆ°ç”»å¸ƒï¼Œè¿çº¿é…ç½®å·¥ä½œæµ</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="showTestPanel()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all flex items-center space-x-2">
                    <i class="fas fa-flask"></i>
                    <span>æµ‹è¯•</span>
                </button>
                <button onclick="saveWorkflow()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-all flex items-center space-x-2">
                    <i class="fas fa-save"></i>
                    <span>ä¿å­˜</span>
                </button>
                <button onclick="closeEditor()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div class="flex h-[calc(100vh-80px)]">
            <!-- å·¦ä¾§ç»„ä»¶é¢æ¿ -->
            <div class="w-64 bg-gray-50 border-r border-gray-200 overflow-y-auto p-4">
                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-boxes mr-2"></i>ç»„ä»¶åº“
                </h4>
                
                <!-- è§†é¢‘æºç»„ä»¶ -->
                <div class="mb-6">
                    <h5 class="text-xs font-semibold text-gray-600 mb-2">è§†é¢‘æº</h5>
                    <div id="sourcesPanel" class="space-y-2">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- ç®—æ³•ç»„ä»¶ -->
                <div class="mb-6">
                    <h5 class="text-xs font-semibold text-gray-600 mb-2">ç®—æ³•</h5>
                    <div id="algorithmsPanel" class="space-y-2">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- æ¡ä»¶åˆ†æ”¯ -->
                <div class="mb-6">
                    <h5 class="text-xs font-semibold text-gray-600 mb-2">æ¡ä»¶åˆ†æ”¯</h5>
                    <div class="space-y-2">
                        <div class="component-item p-3 bg-white border-2 border-yellow-200 rounded-lg cursor-move hover:shadow-md transition-all"
                            draggable="true" 
                            data-type="condition"
                            data-subtype="detection"
                            ondragstart="handleDragStart(event)">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-code-branch text-yellow-500"></i>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-gray-700">æ£€æµ‹æ¡ä»¶</div>
                                    <div class="text-xs text-gray-500">æ˜¯/å¦æ£€æµ‹åˆ°</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¾“å‡ºç»„ä»¶ -->
                <div>
                    <h5 class="text-xs font-semibold text-gray-600 mb-2">è¾“å‡º</h5>
                    <div class="space-y-2">
                        <div class="component-item p-3 bg-white border-2 border-purple-200 rounded-lg cursor-move hover:shadow-md transition-all"
                            draggable="true" 
                            data-type="output"
                            data-subtype="alert"
                            ondragstart="handleDragStart(event)">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-bell text-purple-500"></i>
                                <span class="text-sm font-medium text-gray-700">å‘Šè­¦è¾“å‡º</span>
                            </div>
                        </div>
                        <div class="component-item p-3 bg-white border-2 border-purple-200 rounded-lg cursor-move hover:shadow-md transition-all"
                            draggable="true" 
                            data-type="output"
                            data-subtype="record"
                            ondragstart="handleDragStart(event)">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-video text-purple-500"></i>
                                <span class="text-sm font-medium text-gray-700">å½•åƒè¾“å‡º</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´ç”»å¸ƒ -->
            <div class="flex-1 relative bg-gray-100 overflow-hidden">
                <div id="canvas" class="w-full h-full relative"
                    ondrop="handleDrop(event)"
                    ondragover="handleDragOver(event)">
                    <!-- SVG ç”¨äºç»˜åˆ¶è¿çº¿ -->
                    <svg id="connectionsSvg" class="absolute inset-0 w-full h-full pointer-events-none" style="z-index: 1;">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#4B5563" />
                            </marker>
                        </defs>
                    </svg>
                    <!-- èŠ‚ç‚¹å®¹å™¨ -->
                    <div id="nodesContainer" class="absolute inset-0" style="z-index: 2;"></div>
                    
                    <!-- ç©ºçŠ¶æ€æç¤º -->
                    <div id="emptyState" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="text-center text-gray-400">
                            <i class="fas fa-mouse-pointer text-6xl mb-4"></i>
                            <p class="text-lg font-medium">ä»å·¦ä¾§æ‹–æ‹½ç»„ä»¶åˆ°æ­¤å¤„å¼€å§‹é…ç½®å·¥ä½œæµ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§å±æ€§/æµ‹è¯•é¢æ¿ -->
            <div class="w-80 bg-gray-50 border-l border-gray-200 overflow-y-auto p-4">
                <!-- åˆ‡æ¢æ ‡ç­¾ -->
                <div class="flex mb-4 bg-white rounded-lg p-1">
                    <button onclick="switchRightPanel('properties')" id="tabProperties" class="flex-1 px-3 py-2 text-sm font-medium rounded-lg transition-all bg-black text-white">
                        <i class="fas fa-sliders-h mr-2"></i>å±æ€§
                    </button>
                    <button onclick="switchRightPanel('test')" id="tabTest" class="flex-1 px-3 py-2 text-sm font-medium rounded-lg transition-all text-gray-600 hover:bg-gray-100">
                        <i class="fas fa-flask mr-2"></i>æµ‹è¯•
                    </button>
                </div>
                
                <!-- å±æ€§é¢æ¿ -->
                <div id="propertiesPanel">
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-hand-pointer text-4xl mb-3"></i>
                        <p class="text-sm">ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹å±æ€§</p>
                    </div>
                </div>
                
                <!-- æµ‹è¯•é¢æ¿ -->
                <div id="testPanel" class="hidden">
                    <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-flask mr-2"></i>å·¥ä½œæµæµ‹è¯•
                    </h4>
                    
                    <!-- å›¾ç‰‡æ¥æºé€‰æ‹© -->
                    <div class="mb-4">
                        <label class="block text-xs font-semibold text-gray-600 mb-2">å›¾ç‰‡æ¥æº</label>
                        <div class="flex space-x-2 bg-gray-100 rounded-lg p-1">
                            <button onclick="switchImageSource('upload')" id="btnSourceUpload" class="flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all bg-white shadow">
                                <i class="fas fa-upload mr-1"></i>ä¸Šä¼ å›¾ç‰‡
                            </button>
                            <button onclick="switchImageSource('video')" id="btnSourceVideo" class="flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all text-gray-600 hover:bg-white">
                                <i class="fas fa-video mr-1"></i>è§†é¢‘æº
                            </button>
                        </div>
                    </div>
                    
                    <!-- ä¸Šä¼ å›¾ç‰‡åŒºåŸŸ -->
                    <div id="uploadImageArea" class="mb-4">
                        <label class="block text-xs font-semibold text-gray-600 mb-2">ä¸Šä¼ æµ‹è¯•å›¾ç‰‡</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-400 transition-all cursor-pointer"
                            onclick="document.getElementById('testImageInput').click()">
                            <input type="file" id="testImageInput" accept="image/*" class="hidden" onchange="handleTestImageUpload(event)">
                            <i class="fas fa-cloud-upload text-3xl text-gray-400 mb-2"></i>
                            <p class="text-xs text-gray-500">ç‚¹å‡»ä¸Šä¼ æµ‹è¯•å›¾ç‰‡</p>
                        </div>
                    </div>
                    
                    <!-- ä»è§†é¢‘æºè¯»å–åŒºåŸŸ -->
                    <div id="videoSourceArea" class="mb-4 hidden">
                        <label class="block text-xs font-semibold text-gray-600 mb-2">é€‰æ‹©è§†é¢‘æº</label>
                        <select id="videoSourceSelect" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-black mb-2">
                            <option value="">-- è¯·é€‰æ‹©è§†é¢‘æº --</option>
                        </select>
                        <button onclick="captureFrameFromVideo()" id="btnCaptureFrame" class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-camera mr-2"></i>æŠ“å–å½“å‰å¸§
                        </button>
                    </div>
                    
                    <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
                    <div id="testImagePreview" class="mb-4 hidden">
                        <label class="block text-xs font-semibold text-gray-600 mb-2">æµ‹è¯•å›¾ç‰‡é¢„è§ˆ</label>
                        <div class="relative">
                            <img id="testImagePreviewImg" src="" class="w-full rounded-lg shadow-sm border border-gray-200">
                            <div id="imageSourceBadge" class="absolute top-2 right-2 px-2 py-1 bg-black bg-opacity-70 text-white text-xs rounded"></div>
                        </div>
                        <button onclick="clearTestImage()" class="mt-2 w-full px-3 py-2 bg-red-50 text-red-600 rounded-lg text-xs hover:bg-red-100 transition-all">
                            <i class="fas fa-trash mr-1"></i>æ¸…é™¤å›¾ç‰‡
                        </button>
                    </div>
                    
                    <!-- æµ‹è¯•æŒ‰é’® -->
                    <button onclick="runWorkflowTest()" id="runTestBtn" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all mb-4 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-play mr-2"></i>è¿è¡Œæµ‹è¯•
                    </button>
                    
                    <!-- æµ‹è¯•ç»“æœ -->
                    <div id="testResults" class="hidden">
                        <div class="bg-white rounded-lg p-3 mb-3 border border-gray-200">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="text-xs font-bold text-gray-700">æµ‹è¯•ç»“æœ</h5>
                                <span id="testStatus" class="text-xs px-2 py-1 rounded-full"></span>
                            </div>
                            <div id="testResultContent" class="text-xs text-gray-600"></div>
                        </div>
                        
                        <!-- èŠ‚ç‚¹æ‰§è¡Œè¯¦æƒ… -->
                        <div id="nodeExecutionDetails" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .component-item {
        transition: all 0.2s ease;
    }
    
    .component-item:hover {
        transform: translateY(-2px);
    }
    
    .workflow-node {
        position: absolute;
        min-width: 180px;
        background: white;
        border: 2px solid #E5E7EB;
        border-radius: 12px;
        padding: 16px;
        cursor: move;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }
    
    .workflow-node:hover {
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        border-color: #3B82F6;
    }
    
    .workflow-node.selected {
        border-color: #3B82F6;
        border-width: 3px;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    
    .node-connector {
        position: absolute;
        width: 12px;
        height: 12px;
        background: white;
        border: 2px solid #6B7280;
        border-radius: 50%;
        cursor: crosshair;
        transition: all 0.2s ease;
    }
    
    .node-connector:hover {
        width: 16px;
        height: 16px;
        background: #3B82F6;
        border-color: #3B82F6;
    }
    
    .node-connector.output {
        right: -8px;
        top: 50%;
        transform: translateY(-50%);
    }
    
    .node-connector.input {
        left: -8px;
        top: 50%;
        transform: translateY(-50%);
    }
    
    .connection-line {
        fill: none;
        stroke: #4B5563;
        stroke-width: 2;
        marker-end: url(#arrowhead);
    }
    
    .node-source {
        border-color: #10B981;
    }
    
    .node-algorithm {
        border-color: #3B82F6;
    }
    
    .node-output {
        border-color: #8B5CF6;
    }
    
    .node-condition {
        border-color: #F59E0B;
    }
    
    .connection-line.detected {
        stroke: #10B981;
    }
    
    .connection-line.not-detected {
        stroke: #EF4444;
    }
    
    .connection-label {
        font-size: 11px;
        fill: white;
        font-weight: 600;
    }
    
    .connection-label-bg {
        fill: #4B5563;
        rx: 4;
    }
    
    .connection-label-bg.detected {
        fill: #10B981;
    }
    
    .connection-label-bg.not-detected {
        fill: #EF4444;
    }
    
    .node-testing {
        animation: pulse-blue 1s infinite;
    }
    
    .node-success {
        border-color: #10B981 !important;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }
    
    .node-error {
        border-color: #EF4444 !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
    }
    
    @keyframes pulse-blue {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
        }
        50% {
            box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let workflows = [];
    let currentWorkflow = null;
    let nodes = [];
    let connections = [];
    let selectedNode = null;
    let draggedNode = null;
    let isConnecting = false;
    let connectionStart = null;
    let resources = { sources: [], algorithms: [] };
    let nodeIdCounter = 0;
    let testImageData = null;
    let currentRightPanel = 'properties';
    let currentImageSource = 'upload';  // 'upload' æˆ– 'video'

    // åˆ‡æ¢å›¾ç‰‡æ¥æº
    function switchImageSource(source) {
        currentImageSource = source;
        
        // æ›´æ–°æŒ‰é’®æ ·å¼
        if (source === 'upload') {
            document.getElementById('btnSourceUpload').className = 'flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all bg-white shadow';
            document.getElementById('btnSourceVideo').className = 'flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all text-gray-600 hover:bg-white';
            
            document.getElementById('uploadImageArea').classList.remove('hidden');
            document.getElementById('videoSourceArea').classList.add('hidden');
        } else {
            document.getElementById('btnSourceUpload').className = 'flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all text-gray-600 hover:bg-white';
            document.getElementById('btnSourceVideo').className = 'flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all bg-white shadow';
            
            document.getElementById('uploadImageArea').classList.add('hidden');
            document.getElementById('videoSourceArea').classList.remove('hidden');
        }
    }

    // ä»è§†é¢‘æºæŠ“å–å›¾ç‰‡
    async function captureFrameFromVideo() {
        const selectEl = document.getElementById('videoSourceSelect');
        const taskId = selectEl.value;
        
        if (!taskId) {
            showMessage('è¯·å…ˆé€‰æ‹©è§†é¢‘æº', 'warning');
            return;
        }
        
        const btnCapture = document.getElementById('btnCaptureFrame');
        btnCapture.disabled = true;
        btnCapture.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>æŠ“å–ä¸­...';
        
        try {
            const response = await fetch(`/api/workflows/capture_frame/${taskId}`);
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'æŠ“å–å¤±è´¥');
            }
            
            // è®¾ç½®å›¾ç‰‡æ•°æ®
            testImageData = result.image;
            document.getElementById('testImagePreviewImg').src = testImageData;
            document.getElementById('testImagePreview').classList.remove('hidden');
            
            // æ˜¾ç¤ºæ¥æºæ ‡è®°
            const badge = document.getElementById('imageSourceBadge');
            const taskName = result.task_name || 'è§†é¢‘æº';
            const sourceType = result.source === 'snapshot' ? 'å¿«ç…§' : 'å®æ—¶';
            badge.textContent = `${taskName} (${sourceType})`;
            
            document.getElementById('runTestBtn').disabled = false;
            
            showMessage('æˆåŠŸæŠ“å–è§†é¢‘å¸§', 'success');
        } catch (error) {
            showMessage('æŠ“å–å¤±è´¥: ' + error.message, 'error');
        } finally {
            btnCapture.disabled = false;
            btnCapture.innerHTML = '<i class="fas fa-camera mr-2"></i>æŠ“å–å½“å‰å¸§';
        }
    }

    // åˆ‡æ¢å³ä¾§é¢æ¿
    function switchRightPanel(panel) {
        currentRightPanel = panel;
        
        if (panel === 'properties') {
            document.getElementById('propertiesPanel').classList.remove('hidden');
            document.getElementById('testPanel').classList.add('hidden');
            document.getElementById('tabProperties').className = 'flex-1 px-3 py-2 text-sm font-medium rounded-lg transition-all bg-black text-white';
            document.getElementById('tabTest').className = 'flex-1 px-3 py-2 text-sm font-medium rounded-lg transition-all text-gray-600 hover:bg-gray-100';
        } else {
            document.getElementById('propertiesPanel').classList.add('hidden');
            document.getElementById('testPanel').classList.remove('hidden');
            document.getElementById('tabProperties').className = 'flex-1 px-3 py-2 text-sm font-medium rounded-lg transition-all text-gray-600 hover:bg-gray-100';
            document.getElementById('tabTest').className = 'flex-1 px-3 py-2 text-sm font-medium rounded-lg transition-all bg-black text-white';
        }
    }

    function showTestPanel() {
        switchRightPanel('test');
    }

    // å¤„ç†æµ‹è¯•å›¾ç‰‡ä¸Šä¼ 
    function handleTestImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            testImageData = e.target.result;
            document.getElementById('testImagePreviewImg').src = testImageData;
            document.getElementById('testImagePreview').classList.remove('hidden');
            
            // æ˜¾ç¤ºæ¥æºæ ‡è®°
            const badge = document.getElementById('imageSourceBadge');
            badge.textContent = `ä¸Šä¼ : ${file.name}`;
            
            document.getElementById('runTestBtn').disabled = false;
        };
        reader.readAsDataURL(file);
    }

    function clearTestImage() {
        testImageData = null;
        document.getElementById('testImageInput').value = '';
        document.getElementById('videoSourceSelect').value = '';
        document.getElementById('testImagePreview').classList.add('hidden');
        document.getElementById('runTestBtn').disabled = true;
        document.getElementById('testResults').classList.add('hidden');
    }

    // è¿è¡Œå·¥ä½œæµæµ‹è¯•
    async function runWorkflowTest() {
        if (!testImageData) {
            showMessage('è¯·å…ˆä¸Šä¼ æµ‹è¯•å›¾ç‰‡', 'warning');
            return;
        }
        
        if (nodes.length === 0) {
            showMessage('å·¥ä½œæµä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ èŠ‚ç‚¹', 'warning');
            return;
        }
        
        // éªŒè¯å·¥ä½œæµ
        const validation = validateWorkflow();
        if (!validation.valid) {
            showMessage('å·¥ä½œæµé…ç½®é”™è¯¯: ' + validation.error, 'error');
            return;
        }
        
        const runTestBtn = document.getElementById('runTestBtn');
        runTestBtn.disabled = true;
        runTestBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>æµ‹è¯•ä¸­...';
        
        try {
            // æ¸…é™¤ä¹‹å‰çš„æµ‹è¯•çŠ¶æ€
            clearTestStates();
            
            // æ˜¾ç¤ºæµ‹è¯•ç»“æœé¢æ¿
            document.getElementById('testResults').classList.remove('hidden');
            
            // æ‰§è¡Œæµ‹è¯•
            const result = await executeWorkflowTest();
            
            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            displayTestResults(result);
            
        } catch (error) {
            showMessage('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            displayTestError(error);
        } finally {
            runTestBtn.disabled = false;
            runTestBtn.innerHTML = '<i class="fas fa-play mr-2"></i>è¿è¡Œæµ‹è¯•';
        }
    }

    // éªŒè¯å·¥ä½œæµé…ç½®
    function validateWorkflow() {
        // æ£€æŸ¥æ˜¯å¦æœ‰æºèŠ‚ç‚¹
        const sourceNodes = nodes.filter(n => n.type === 'source');
        if (sourceNodes.length === 0) {
            return { valid: false, error: 'ç¼ºå°‘è§†é¢‘æºèŠ‚ç‚¹' };
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰è¾“å‡ºèŠ‚ç‚¹
        const outputNodes = nodes.filter(n => n.type === 'output');
        if (outputNodes.length === 0) {
            return { valid: false, error: 'ç¼ºå°‘è¾“å‡ºèŠ‚ç‚¹' };
        }
        
        // æ£€æŸ¥è¿çº¿
        if (connections.length === 0) {
            return { valid: false, error: 'èŠ‚ç‚¹æœªè¿æ¥' };
        }
        
        return { valid: true };
    }

    // æ¸…é™¤æµ‹è¯•çŠ¶æ€
    function clearTestStates() {
        document.querySelectorAll('.workflow-node').forEach(node => {
            node.classList.remove('node-testing', 'node-success', 'node-error');
        });
    }

    // æ‰§è¡Œå·¥ä½œæµæµ‹è¯•ï¼ˆæ¨¡æ‹Ÿï¼‰
    async function executeWorkflowTest() {
        const executionOrder = getExecutionOrder();
        const results = {
            success: true,
            nodes: [],
            totalTime: 0
        };
        
        // ç»´æŠ¤å·²æ‰§è¡ŒèŠ‚ç‚¹çš„ç»“æœæ˜ å°„
        const executedResults = new Map();
        
        // è®°å½•åº”è¯¥è·³è¿‡çš„èŠ‚ç‚¹ï¼ˆä¸æ»¡è¶³æ¡ä»¶åˆ†æ”¯çš„èŠ‚ç‚¹ï¼‰
        const skipNodes = new Set();
        
        for (const nodeId of executionOrder) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) continue;
            
            // å¦‚æœèŠ‚ç‚¹è¢«æ ‡è®°ä¸ºè·³è¿‡ï¼Œåˆ™ä¸æ‰§è¡Œ
            if (skipNodes.has(nodeId)) {
                console.log(`è·³è¿‡èŠ‚ç‚¹: ${node.name} (ä¸æ»¡è¶³æ¡ä»¶åˆ†æ”¯)`);
                continue;
            }
            
            // æ ‡è®°èŠ‚ç‚¹ä¸ºæµ‹è¯•ä¸­
            markNodeTesting(nodeId);
            
            // æ¨¡æ‹ŸèŠ‚ç‚¹æ‰§è¡Œ
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // æ‰§è¡ŒèŠ‚ç‚¹
            try {
                const nodeResult = await executeNode(node, executedResults);
                results.nodes.push(nodeResult);
                executedResults.set(nodeId, nodeResult);
                
                if (nodeResult.success) {
                    markNodeSuccess(nodeId);
                    
                    // å¦‚æœæ˜¯æ¡ä»¶èŠ‚ç‚¹ï¼Œæ ¹æ®ç»“æœå†³å®šåç»­å“ªäº›èŠ‚ç‚¹éœ€è¦è·³è¿‡
                    if (node.type === 'condition') {
                        const conditionResult = nodeResult.data.condition; // 'detected' æˆ– 'not_detected'
                        
                        // æŸ¥æ‰¾ä»è¯¥æ¡ä»¶èŠ‚ç‚¹å‡ºå‘çš„æ‰€æœ‰è¿çº¿
                        const outgoingConnections = connections.filter(c => c.from === nodeId);
                        
                        for (const conn of outgoingConnections) {
                            // å¦‚æœè¿çº¿çš„æ¡ä»¶ä¸å½“å‰ç»“æœä¸åŒ¹é…ï¼Œæ ‡è®°ç›®æ ‡èŠ‚ç‚¹åŠå…¶æ‰€æœ‰åç»­èŠ‚ç‚¹ä¸ºè·³è¿‡
                            if (conn.condition && conn.condition !== conditionResult) {
                                markNodeAndDescendantsToSkip(conn.to, skipNodes);
                            }
                        }
                    }
                } else {
                    markNodeError(nodeId);
                    results.success = false;
                    break;
                }
            } catch (error) {
                markNodeError(nodeId);
                results.nodes.push({
                    nodeId: nodeId,
                    nodeName: node.name,
                    success: false,
                    error: error.message
                });
                results.success = false;
                break;
            }
        }
        
        return results;
    }
    
    // æ ‡è®°èŠ‚ç‚¹åŠå…¶æ‰€æœ‰åç»­èŠ‚ç‚¹ä¸ºè·³è¿‡
    function markNodeAndDescendantsToSkip(nodeId, skipNodes) {
        if (skipNodes.has(nodeId)) return;
        
        skipNodes.add(nodeId);
        
        // é€’å½’æ ‡è®°æ‰€æœ‰åç»­èŠ‚ç‚¹
        const outgoingConnections = connections.filter(c => c.from === nodeId);
        for (const conn of outgoingConnections) {
            markNodeAndDescendantsToSkip(conn.to, skipNodes);
        }
    }

    // è·å–æ‰§è¡Œé¡ºåºï¼ˆæ‹“æ‰‘æ’åºï¼‰
    function getExecutionOrder() {
        const order = [];
        const visited = new Set();
        const visiting = new Set();
        
        function visit(nodeId) {
            if (visited.has(nodeId)) return;
            if (visiting.has(nodeId)) {
                throw new Error('æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–');
            }
            
            visiting.add(nodeId);
            
            // è®¿é—®æ‰€æœ‰å‰ç½®èŠ‚ç‚¹
            const incomingConnections = connections.filter(c => c.to === nodeId);
            for (const conn of incomingConnections) {
                visit(conn.from);
            }
            
            visiting.delete(nodeId);
            visited.add(nodeId);
            order.push(nodeId);
        }
        
        // ä»æ‰€æœ‰èŠ‚ç‚¹å¼€å§‹è®¿é—®
        for (const node of nodes) {
            if (!visited.has(node.id)) {
                visit(node.id);
            }
        }
        
        return order;
    }

    // æ‰§è¡Œå•ä¸ªèŠ‚ç‚¹
    async function executeNode(node, executedResults) {
        const startTime = Date.now();
        
        let result = {
            nodeId: node.id,
            nodeName: node.name,
            nodeType: node.type,
            success: true,
            executionTime: 0,
            data: {}
        };
        
        try {
            switch (node.type) {
                case 'source':
                    result.data = {
                        message: 'è§†é¢‘æºåŠ è½½æˆåŠŸ',
                        resolution: '1920x1080',
                        fps: 25
                    };
                    break;
                    
                case 'algorithm':
                    // è°ƒç”¨å®é™…çš„ç®—æ³•æµ‹è¯•API
                    if (node.dataId) {
                        const apiResult = await testAlgorithmWithImage(node.dataId, testImageData);
                        result.data = {
                            detections: apiResult.detections || [],
                            detection_count: apiResult.detection_count || 0,
                            confidence: apiResult.confidence || 0,
                            result_image: apiResult.result_image
                        };
                    } else {
                        result.data = {
                            message: 'ç®—æ³•èŠ‚ç‚¹ï¼ˆæ¨¡æ‹Ÿï¼‰',
                            detections: [],
                            detection_count: 0
                        };
                    }
                    break;
                    
                case 'condition':
                    // æ ¹æ®å‰ç½®èŠ‚ç‚¹çš„æ£€æµ‹ç»“æœåˆ¤æ–­
                    const prevNode = getPreviousNodeResult(node.id, executedResults);
                    const detected = prevNode && prevNode.data && prevNode.data.detection_count > 0;
                    result.data = {
                        condition: detected ? 'detected' : 'not_detected',
                        message: detected ? 'æ£€æµ‹åˆ°ç›®æ ‡' : 'æœªæ£€æµ‹åˆ°ç›®æ ‡',
                        branch: detected ? 'æ˜¯' : 'å¦'
                    };
                    break;
                    
                case 'output':
                    result.data = {
                        message: node.subtype === 'alert' ? 'å‘Šè­¦å·²è§¦å‘' : 'å½•åƒå·²ä¿å­˜',
                        outputType: node.subtype
                    };
                    break;
            }
        } catch (error) {
            result.success = false;
            result.error = error.message;
        }
        
        result.executionTime = Date.now() - startTime;
        return result;
    }

    // è·å–å‰ç½®èŠ‚ç‚¹çš„ç»“æœ
    function getPreviousNodeResult(nodeId, executedResults) {
        // æŸ¥æ‰¾ç›´æ¥è¿æ¥åˆ°å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹
        const incomingConnection = connections.find(c => c.to === nodeId);
        if (!incomingConnection) {
            return null;
        }
        
        // ä»å·²æ‰§è¡Œç»“æœä¸­æŸ¥æ‰¾å‰ç½®èŠ‚ç‚¹çš„ç»“æœ
        const prevNodeId = incomingConnection.from;
        return executedResults.get(prevNodeId) || null;
    }

    // è°ƒç”¨ç®—æ³•æµ‹è¯•API
    async function testAlgorithmWithImage(algorithmId, imageData) {
        try {
            // å°†base64è½¬æ¢ä¸ºblob
            const response = await fetch(imageData);
            const blob = await response.blob();
            
            // åˆ›å»ºFormData
            const formData = new FormData();
            formData.append('image', blob, 'test.jpg');
            formData.append('algorithm_id', algorithmId);
            
            // è°ƒç”¨æµ‹è¯•API
            const result = await fetch('/api/algorithms/test', {
                method: 'POST',
                body: formData
            });
            
            if (!result.ok) {
                throw new Error('ç®—æ³•æµ‹è¯•å¤±è´¥');
            }
            
            return await result.json();
        } catch (error) {
            console.error('ç®—æ³•æµ‹è¯•é”™è¯¯:', error);
            return {
                success: false,
                detections: [],
                detection_count: 0
            };
        }
    }

    // æ ‡è®°èŠ‚ç‚¹çŠ¶æ€
    function markNodeTesting(nodeId) {
        const nodeEl = document.querySelector(`[data-node-id="${nodeId}"]`);
        if (nodeEl) {
            nodeEl.classList.add('node-testing');
        }
    }

    function markNodeSuccess(nodeId) {
        const nodeEl = document.querySelector(`[data-node-id="${nodeId}"]`);
        if (nodeEl) {
            nodeEl.classList.remove('node-testing');
            nodeEl.classList.add('node-success');
        }
    }

    function markNodeError(nodeId) {
        const nodeEl = document.querySelector(`[data-node-id="${nodeId}"]`);
        if (nodeEl) {
            nodeEl.classList.remove('node-testing');
            nodeEl.classList.add('node-error');
        }
    }

    // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
    function displayTestResults(results) {
        const statusEl = document.getElementById('testStatus');
        const contentEl = document.getElementById('testResultContent');
        const detailsEl = document.getElementById('nodeExecutionDetails');
        
        if (results.success) {
            statusEl.className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-700';
            statusEl.textContent = 'æµ‹è¯•é€šè¿‡';
            contentEl.innerHTML = `
                <div class="text-sm">
                    <p class="mb-1">âœ“ æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸ</p>
                    <p class="text-gray-500">å…±æ‰§è¡Œ ${results.nodes.length} ä¸ªèŠ‚ç‚¹</p>
                </div>
            `;
        } else {
            statusEl.className = 'text-xs px-2 py-1 rounded-full bg-red-100 text-red-700';
            statusEl.textContent = 'æµ‹è¯•å¤±è´¥';
            contentEl.innerHTML = `
                <div class="text-sm">
                    <p class="mb-1">âœ— æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯</p>
                    <p class="text-gray-500">æ‰§è¡Œäº† ${results.nodes.length} ä¸ªèŠ‚ç‚¹</p>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºèŠ‚ç‚¹æ‰§è¡Œè¯¦æƒ…
        detailsEl.innerHTML = results.nodes.map(node => `
            <div class="bg-white rounded-lg p-3 border ${node.success ? 'border-green-200' : 'border-red-200'}">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <i class="fas ${node.success ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}"></i>
                        <span class="text-xs font-bold text-gray-700">${node.nodeName}</span>
                    </div>
                    <span class="text-xs text-gray-500">${node.executionTime}ms</span>
                </div>
                <div class="text-xs text-gray-600">
                    ${node.success ? formatNodeData(node) : `<p class="text-red-600">é”™è¯¯: ${node.error}</p>`}
                </div>
                ${node.data && node.data.result_image ? `
                    <div class="mt-2">
                        <img src="${node.data.result_image}" class="w-full rounded-lg shadow-sm">
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    function formatNodeData(node) {
        const data = node.data;
        
        switch (node.nodeType) {
            case 'source':
                return `<p>âœ“ ${data.message}</p><p class="text-gray-500">åˆ†è¾¨ç‡: ${data.resolution}, å¸§ç‡: ${data.fps}</p>`;
                
            case 'algorithm':
                if (data.detection_count > 0) {
                    return `<p>âœ“ æ£€æµ‹åˆ° ${data.detection_count} ä¸ªç›®æ ‡</p>`;
                } else {
                    return `<p>æœªæ£€æµ‹åˆ°ç›®æ ‡</p>`;
                }
                
            case 'condition':
                return `<p>âœ“ ${data.message}</p><p class="text-gray-500">æ‰§è¡Œåˆ†æ”¯: ${data.branch}</p>`;
                
            case 'output':
                return `<p>âœ“ ${data.message}</p>`;
                
            default:
                return `<p>${data.message || 'æ‰§è¡ŒæˆåŠŸ'}</p>`;
        }
    }

    function displayTestError(error) {
        const statusEl = document.getElementById('testStatus');
        const contentEl = document.getElementById('testResultContent');
        
        statusEl.className = 'text-xs px-2 py-1 rounded-full bg-red-100 text-red-700';
        statusEl.textContent = 'æµ‹è¯•å¤±è´¥';
        contentEl.innerHTML = `
            <div class="text-sm text-red-600">
                <p>âœ— ${error.message}</p>
            </div>
        `;
        
        document.getElementById('testResults').classList.remove('hidden');
    }

    // åŠ è½½å·¥ä½œæµåˆ—è¡¨
    async function loadWorkflows() {
        try {
            workflows = await apiRequest('/api/workflows');
            renderWorkflowsTable();
        } catch (error) {
            showMessage('åŠ è½½å·¥ä½œæµå¤±è´¥: ' + error.message, 'error');
        }
    }

    function renderWorkflowsTable() {
        const tbody = document.getElementById('workflowsTable');
        const count = document.getElementById('workflowCount');
        count.textContent = `å…± ${workflows.length} ä¸ªå·¥ä½œæµ`;
        
        tbody.innerHTML = workflows.map(w => `
            <tr class="hover:bg-gray-50 transition-all duration-200">
                <td class="px-6 py-5 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-black rounded-lg flex items-center justify-center text-white mr-3">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div class="font-semibold text-gray-800">${w.name}</div>
                    </div>
                </td>
                <td class="px-6 py-5">
                    <div class="text-sm text-gray-600">${w.description || 'æ— æè¿°'}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap">
                    <span class="inline-flex items-center px-3 py-1.5 rounded-lg ${w.is_active ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-gray-100 text-gray-700 border border-gray-300'} font-medium text-xs">
                        <span class="w-2 h-2 ${w.is_active ? 'bg-green-500' : 'bg-gray-500'} rounded-full mr-2"></span>
                        ${w.is_active ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}
                    </span>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-sm text-gray-600">
                    ${w.updated_at ? new Date(w.updated_at).toLocaleString('zh-CN') : '-'}
                </td>
                <td class="px-6 py-5 whitespace-nowrap">
                    <div class="flex items-center space-x-2">
                        <button onclick="editWorkflow(${w.id})" class="px-3 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all font-medium text-sm">
                            <i class="fas fa-edit mr-1"></i>ç¼–è¾‘
                        </button>
                        ${!w.is_active ? `
                            <button onclick="activateWorkflow(${w.id})" class="px-3 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-all font-medium text-sm">
                                <i class="fas fa-play mr-1"></i>æ¿€æ´»
                            </button>
                        ` : `
                            <button onclick="deactivateWorkflow(${w.id})" class="px-3 py-2 bg-yellow-50 text-yellow-600 rounded-lg hover:bg-yellow-100 transition-all font-medium text-sm">
                                <i class="fas fa-pause mr-1"></i>åœç”¨
                            </button>
                        `}
                        <button onclick="deleteWorkflow(${w.id})" class="px-3 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-all font-medium text-sm">
                            <i class="fas fa-trash mr-1"></i>åˆ é™¤
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function showCreateModal() {
        document.getElementById('modalTitle').textContent = 'æ–°å»ºå·¥ä½œæµ';
        document.getElementById('workflowForm').reset();
        document.getElementById('workflowId').value = '';
        document.getElementById('workflowModal').classList.remove('hidden');
    }

    function closeWorkflowModal() {
        document.getElementById('workflowModal').classList.add('hidden');
    }

    async function handleWorkflowSubmit(event) {
        event.preventDefault();
        
        const name = document.getElementById('workflowName').value;
        const description = document.getElementById('workflowDescription').value;
        
        try {
            const result = await apiRequest('/api/workflows', 'POST', {
                name: name,
                description: description,
                workflow_data: { nodes: [], connections: [] }
            });
            
            showMessage('å·¥ä½œæµåˆ›å»ºæˆåŠŸ');
            closeWorkflowModal();
            await loadWorkflows();
            
            // æ‰“å¼€ç¼–è¾‘å™¨
            editWorkflow(result.id);
        } catch (error) {
            showMessage('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
        }
    }

    async function editWorkflow(id) {
        try {
            currentWorkflow = await apiRequest(`/api/workflows/${id}`);
            resources = await apiRequest('/api/workflows/resources');
            
            document.getElementById('editorTitle').textContent = currentWorkflow.name;
            document.getElementById('editorSubtitle').textContent = currentWorkflow.description || 'é…ç½®å·¥ä½œæµ';
            
            // åˆå§‹åŒ–ç”»å¸ƒ
            nodes = currentWorkflow.workflow_data?.nodes || [];
            connections = currentWorkflow.workflow_data?.connections || [];
            
            console.log('åŠ è½½å·¥ä½œæµæ•°æ®:', {
                nodes: nodes.length,
                connections: connections.length,
                workflow_data: currentWorkflow.workflow_data
            });
            
            // æ›´æ–° nodeIdCounter é¿å…IDå†²çª
            if (nodes.length > 0) {
                const maxId = nodes.reduce((max, node) => {
                    const match = node.id.match(/node_(\d+)_/);
                    return match ? Math.max(max, parseInt(match[1])) : max;
                }, 0);
                nodeIdCounter = maxId;
            }
            
            renderComponentPanels();
            renderCanvas();
            
            document.getElementById('editorModal').classList.remove('hidden');
        } catch (error) {
            showMessage('æ‰“å¼€ç¼–è¾‘å™¨å¤±è´¥: ' + error.message, 'error');
        }
    }

    function renderComponentPanels() {
        // æ¸²æŸ“è§†é¢‘æº
        const sourcesPanel = document.getElementById('sourcesPanel');
        sourcesPanel.innerHTML = resources.sources.map(s => `
            <div class="component-item p-3 bg-white border-2 border-green-200 rounded-lg cursor-move hover:shadow-md transition-all"
                draggable="true" 
                data-type="source"
                data-id="${s.id}"
                data-name="${s.name}"
                ondragstart="handleDragStart(event)">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-video text-green-500"></i>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-700 truncate">${s.name}</div>
                        <div class="text-xs text-gray-500 truncate">${s.source_code}</div>
                    </div>
                </div>
            </div>
        `).join('');
        
        // å¡«å……è§†é¢‘æºä¸‹æ‹‰åˆ—è¡¨ï¼ˆç”¨äºæµ‹è¯•é¢æ¿ï¼‰
        const videoSourceSelect = document.getElementById('videoSourceSelect');
        videoSourceSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©è§†é¢‘æº --</option>' + 
            resources.sources.map(s => {
                const statusIcon = s.status === 'RUNNING' ? 'ğŸŸ¢' : 'âš«';
                const statusText = s.status === 'RUNNING' ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                return `<option value="${s.id}">${statusIcon} ${s.name} (${statusText})</option>`;
            }).join('');
        
        // æ¸²æŸ“ç®—æ³•
        const algorithmsPanel = document.getElementById('algorithmsPanel');
        algorithmsPanel.innerHTML = resources.algorithms.map(a => `
            <div class="component-item p-3 bg-white border-2 border-blue-200 rounded-lg cursor-move hover:shadow-md transition-all"
                draggable="true" 
                data-type="algorithm"
                data-id="${a.id}"
                data-name="${a.name}"
                ondragstart="handleDragStart(event)">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-brain text-blue-500"></i>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-700 truncate">${a.name}</div>
                        <div class="text-xs text-gray-500 truncate">${a.label_name}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderCanvas() {
        const container = document.getElementById('nodesContainer');
        const svg = document.getElementById('connectionsSvg');
        const emptyState = document.getElementById('emptyState');
        
        // æ¸…ç©º
        container.innerHTML = '';
        // ä¸åœ¨è¿™é‡Œæ¸…ç©ºsvgï¼Œè®©renderConnectionsç»Ÿä¸€å¤„ç†
        
        // æ˜¾ç¤º/éšè—ç©ºçŠ¶æ€
        emptyState.style.display = nodes.length === 0 ? 'flex' : 'none';
        
        // æ¸²æŸ“èŠ‚ç‚¹
        nodes.forEach(node => {
            const nodeEl = createNodeElement(node);
            container.appendChild(nodeEl);
        });
        
        // å»¶è¿Ÿæ¸²æŸ“è¿çº¿ï¼Œç¡®ä¿æµè§ˆå™¨å®Œæˆå¸ƒå±€
        requestAnimationFrame(() => {
            renderConnections();
        });
    }

    function createNodeElement(node) {
        const div = document.createElement('div');
        div.className = `workflow-node node-${node.type}`;
        div.style.left = node.x + 'px';
        div.style.top = node.y + 'px';
        div.dataset.nodeId = node.id;
        
        let icon, color, typeLabel;
        switch(node.type) {
            case 'source':
                icon = 'fa-video';
                color = 'text-green-500';
                typeLabel = 'è§†é¢‘æº';
                break;
            case 'algorithm':
                icon = 'fa-brain';
                color = 'text-blue-500';
                typeLabel = 'ç®—æ³•';
                break;
            case 'condition':
                icon = 'fa-code-branch';
                color = 'text-yellow-500';
                typeLabel = 'æ¡ä»¶åˆ†æ”¯';
                break;
            case 'output':
                icon = node.subtype === 'alert' ? 'fa-bell' : 'fa-video';
                color = 'text-purple-500';
                typeLabel = 'è¾“å‡º';
                break;
        }
        
        // æ„å»ºè¿æ¥ç‚¹HTML
        let connectorsHtml = '';
        
        // è¾“å…¥è¿æ¥ç‚¹ï¼ˆé™¤äº†è§†é¢‘æºèŠ‚ç‚¹ï¼‰
        if (node.type !== 'source') {
            connectorsHtml += '<div class="node-connector input" data-port="input" onmousedown="startConnection(event, \'' + node.id + '\', \'input\')"></div>';
        }
        
        // è¾“å‡ºè¿æ¥ç‚¹ï¼ˆæ ¹æ®èŠ‚ç‚¹ç±»å‹ï¼‰
        if (node.type === 'condition') {
            // æ¡ä»¶èŠ‚ç‚¹æœ‰ä¸¤ä¸ªè¾“å‡ºï¼šæ˜¯/å¦
            connectorsHtml += `
                <div class="node-connector output" data-port="true" onmousedown="startConnection(event, '${node.id}', 'true')" 
                    style="right: -8px; top: 30%; background: #10B981; border-color: #10B981;" title="æ£€æµ‹åˆ°">
                    <span style="position: absolute; right: 20px; top: -2px; font-size: 10px; color: #10B981; font-weight: bold; white-space: nowrap;">æ˜¯</span>
                </div>
                <div class="node-connector output" data-port="false" onmousedown="startConnection(event, '${node.id}', 'false')" 
                    style="right: -8px; top: 70%; background: #EF4444; border-color: #EF4444;" title="æœªæ£€æµ‹åˆ°">
                    <span style="position: absolute; right: 20px; top: -2px; font-size: 10px; color: #EF4444; font-weight: bold; white-space: nowrap;">å¦</span>
                </div>
            `;
        } else if (node.type !== 'output') {
            // æ™®é€šè¾“å‡ºè¿æ¥ç‚¹ï¼ˆç®—æ³•å¯ä»¥æœ‰å¤šä¸ªè¾“å‡ºï¼‰
            connectorsHtml += '<div class="node-connector output" data-port="output" onmousedown="startConnection(event, \'' + node.id + '\', \'output\')"></div>';
        }
        
        div.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center space-x-2">
                    <i class="fas ${icon} ${color}"></i>
                    <span class="font-semibold text-gray-800 text-sm">${node.name}</span>
                </div>
                <button onclick="deleteNode('${node.id}')" class="text-gray-400 hover:text-red-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="text-xs text-gray-500">${typeLabel}</div>
            ${connectorsHtml}
        `;
        
        // æ·»åŠ æ‹–åŠ¨å’Œé€‰æ‹©äº‹ä»¶
        div.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('node-connector')) return;
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'I') return;
            
            selectNode(node.id);
            startNodeDrag(e, node.id);
        });
        
        return div;
    }

    function selectNode(nodeId) {
        // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.workflow-node').forEach(n => n.classList.remove('selected'));
        
        // æ·»åŠ é€‰ä¸­çŠ¶æ€
        const nodeEl = document.querySelector(`[data-node-id="${nodeId}"]`);
        if (nodeEl) {
            nodeEl.classList.add('selected');
            selectedNode = nodes.find(n => n.id === nodeId);
            renderPropertiesPanel();
        }
    }

    function renderPropertiesPanel() {
        const panel = document.getElementById('propertiesPanel');
        
        if (!selectedNode) {
            panel.innerHTML = `
                <div class="text-center text-gray-400 py-8">
                    <i class="fas fa-hand-pointer text-4xl mb-3"></i>
                    <p class="text-sm">ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹å±æ€§</p>
                </div>
            `;
            return;
        }
        
        panel.innerHTML = `
            <h4 class="text-sm font-bold text-gray-700 mb-4">èŠ‚ç‚¹å±æ€§</h4>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1">èŠ‚ç‚¹åç§°</label>
                    <div class="px-3 py-2 bg-gray-100 rounded-lg text-sm text-gray-700">${selectedNode.name}</div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1">èŠ‚ç‚¹ç±»å‹</label>
                    <div class="px-3 py-2 bg-gray-100 rounded-lg text-sm text-gray-700">${selectedNode.type}</div>
                </div>
                ${selectedNode.dataId ? `
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">å…³è”ID</label>
                        <div class="px-3 py-2 bg-gray-100 rounded-lg text-sm text-gray-700">${selectedNode.dataId}</div>
                    </div>
                ` : ''}
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1">ä½ç½®</label>
                    <div class="px-3 py-2 bg-gray-100 rounded-lg text-sm text-gray-700">X: ${Math.round(selectedNode.x)}, Y: ${Math.round(selectedNode.y)}</div>
                </div>
            </div>
        `;
    }

    function startNodeDrag(e, nodeId) {
        draggedNode = nodes.find(n => n.id === nodeId);
        if (!draggedNode) return;
        
        const nodeEl = document.querySelector(`[data-node-id="${nodeId}"]`);
        const rect = nodeEl.getBoundingClientRect();
        const canvasRect = document.getElementById('canvas').getBoundingClientRect();
        
        const offsetX = e.clientX - rect.left;
        const offsetY = e.clientY - rect.top;
        
        function onMouseMove(e) {
            if (!draggedNode) return;
            
            draggedNode.x = e.clientX - canvasRect.left - offsetX;
            draggedNode.y = e.clientY - canvasRect.top - offsetY;
            
            nodeEl.style.left = draggedNode.x + 'px';
            nodeEl.style.top = draggedNode.y + 'px';
            
            renderConnections();
            renderPropertiesPanel();
        }
        
        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            draggedNode = null;
        }
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }

    function renderConnections() {
        const svg = document.getElementById('connectionsSvg');
        const defs = svg.querySelector('defs');
        
        // æ¸…ç©ºSVGä½†ä¿ç•™defs
        if (defs) {
            svg.innerHTML = defs.outerHTML;
        } else {
            // å¦‚æœdefsä¸å­˜åœ¨ï¼Œé‡æ–°åˆ›å»º
            svg.innerHTML = `
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#4B5563" />
                    </marker>
                </defs>
            `;
        }
        
        console.log('æ¸²æŸ“è¿çº¿:', connections.length, 'æ¡');
        
        connections.forEach((conn, index) => {
            const fromNode = nodes.find(n => n.id === conn.from);
            const toNode = nodes.find(n => n.id === conn.to);
            
            if (!fromNode || !toNode) {
                console.warn(`è¿çº¿ ${index} æ‰¾ä¸åˆ°èŠ‚ç‚¹:`, {
                    from: conn.from, 
                    to: conn.to,
                    fromNode: !!fromNode,
                    toNode: !!toNode
                });
                return;
            }
            
            const fromEl = document.querySelector(`[data-node-id="${conn.from}"]`);
            const toEl = document.querySelector(`[data-node-id="${conn.to}"]`);
            
            if (!fromEl || !toEl) {
                console.warn(`è¿çº¿ ${index} æ‰¾ä¸åˆ°DOMå…ƒç´ :`, {
                    from: conn.from,
                    to: conn.to,
                    fromEl: !!fromEl,
                    toEl: !!toEl
                });
                return;
            }
            
            const fromRect = fromEl.getBoundingClientRect();
            const toRect = toEl.getBoundingClientRect();
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            
            // è®¡ç®—èµ·ç‚¹åæ ‡ï¼ˆæ ¹æ®fromPortï¼‰
            let x1, y1;
            if (conn.fromPort === 'true') {
                x1 = fromRect.right - canvasRect.left;
                y1 = fromRect.top + fromRect.height * 0.3 - canvasRect.top;
            } else if (conn.fromPort === 'false') {
                x1 = fromRect.right - canvasRect.left;
                y1 = fromRect.top + fromRect.height * 0.7 - canvasRect.top;
            } else {
                x1 = fromRect.right - canvasRect.left;
                y1 = (fromRect.top + fromRect.bottom) / 2 - canvasRect.top;
            }
            
            const x2 = toRect.left - canvasRect.left;
            const y2 = (toRect.top + toRect.bottom) / 2 - canvasRect.top;
            
            const midX = (x1 + x2) / 2;
            
            console.log(`è¿çº¿ ${index}: (${x1.toFixed(1)}, ${y1.toFixed(1)}) -> (${x2.toFixed(1)}, ${y2.toFixed(1)})`);
            
            // åˆ›å»ºè·¯å¾„
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            let pathClass = 'connection-line';
            if (conn.condition === 'detected') {
                pathClass += ' detected';
            } else if (conn.condition === 'not_detected') {
                pathClass += ' not-detected';
            }
            path.setAttribute('class', pathClass);
            path.setAttribute('d', `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`);
            
            svg.appendChild(path);
            console.log(`å·²æ·»åŠ è·¯å¾„å…ƒç´ ï¼Œclass=${pathClass}`);
            
            // æ·»åŠ æ ‡ç­¾ï¼ˆå¦‚æœæœ‰æ¡ä»¶ï¼‰
            if (conn.label) {
                const labelX = midX;
                const labelY = (y1 + y2) / 2;
                
                // èƒŒæ™¯çŸ©å½¢
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('class', 'connection-label-bg ' + (conn.condition === 'detected' ? 'detected' : 'not-detected'));
                rect.setAttribute('x', labelX - 25);
                rect.setAttribute('y', labelY - 10);
                rect.setAttribute('width', 50);
                rect.setAttribute('height', 20);
                svg.appendChild(rect);
                
                // æ–‡å­—
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('class', 'connection-label');
                text.setAttribute('x', labelX);
                text.setAttribute('y', labelY + 4);
                text.setAttribute('text-anchor', 'middle');
                text.textContent = conn.label;
                svg.appendChild(text);
            }
        });
    }

    function handleDragStart(event) {
        const type = event.target.dataset.type;
        const dataId = event.target.dataset.id;
        const name = event.target.dataset.name;
        const subtype = event.target.dataset.subtype;
        
        event.dataTransfer.setData('type', type);
        event.dataTransfer.setData('dataId', dataId || '');
        event.dataTransfer.setData('name', name || '');
        event.dataTransfer.setData('subtype', subtype || '');
    }

    function handleDragOver(event) {
        event.preventDefault();
    }

    function handleDrop(event) {
        event.preventDefault();
        
        const type = event.dataTransfer.getData('type');
        const dataId = event.dataTransfer.getData('dataId');
        const name = event.dataTransfer.getData('name');
        const subtype = event.dataTransfer.getData('subtype');
        
        const canvasRect = document.getElementById('canvas').getBoundingClientRect();
        const x = event.clientX - canvasRect.left - 90; // 90 = èŠ‚ç‚¹å®½åº¦çš„ä¸€åŠ
        const y = event.clientY - canvasRect.top - 40;  // 40 = èŠ‚ç‚¹é«˜åº¦çš„ä¸€åŠ
        
        let nodeName = name;
        if (!nodeName) {
            if (type === 'output') {
                nodeName = subtype === 'alert' ? 'å‘Šè­¦è¾“å‡º' : 'å½•åƒè¾“å‡º';
            } else if (type === 'condition') {
                nodeName = subtype === 'detection' ? 'æ£€æµ‹æ¡ä»¶' : 'æ¡ä»¶åˆ†æ”¯';
            } else {
                nodeName = 'æœªå‘½å';
            }
        }
        
        const node = {
            id: 'node_' + (++nodeIdCounter) + '_' + Date.now(),
            type: type,
            subtype: subtype || null,
            name: nodeName,
            dataId: dataId || null,
            x: Math.max(0, x),
            y: Math.max(0, y)
        };
        
        nodes.push(node);
        renderCanvas();
    }

    function deleteNode(nodeId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹å—ï¼Ÿç›¸å…³è¿çº¿ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) return;
        
        nodes = nodes.filter(n => n.id !== nodeId);
        // åŒæ—¶åˆ é™¤æ‰€æœ‰ç›¸å…³çš„è¿çº¿
        connections = connections.filter(c => c.from !== nodeId && c.to !== nodeId);
        selectedNode = null;
        renderCanvas();
        renderPropertiesPanel();
    }

    function startConnection(event, nodeId, connectorType) {
        event.stopPropagation();
        
        // å¦‚æœæ˜¯è¾“å‡ºè¿æ¥ç‚¹ï¼ˆoutput, true, falseï¼‰
        if (['output', 'true', 'false'].includes(connectorType)) {
            isConnecting = true;
            connectionStart = { 
                nodeId: nodeId, 
                port: connectorType,
                condition: connectorType === 'true' ? 'detected' : connectorType === 'false' ? 'not_detected' : null
            };
        } else if (connectorType === 'input') {
            // å¦‚æœç‚¹å‡»çš„æ˜¯ inputï¼ŒæŸ¥æ‰¾æ˜¯å¦æœ‰è¿åˆ°è¿™ä¸ªèŠ‚ç‚¹çš„è¿çº¿
            const existingConn = connections.find(c => c.to === nodeId);
            if (existingConn) {
                // åˆ é™¤è¿çº¿
                connections = connections.filter(c => c !== existingConn);
                renderConnections();
            }
        }
        
        document.addEventListener('mouseup', endConnection);
    }

    function endConnection(event) {
        if (!isConnecting || !connectionStart) {
            isConnecting = false;
            connectionStart = null;
            document.removeEventListener('mouseup', endConnection);
            return;
        }
        
        // æŸ¥æ‰¾é¼ æ ‡é‡Šæ”¾ä½ç½®çš„èŠ‚ç‚¹
        const element = document.elementFromPoint(event.clientX, event.clientY);
        const connector = element?.closest('.node-connector.input');
        
        if (connector) {
            const nodeEl = connector.closest('.workflow-node');
            const toNodeId = nodeEl.dataset.nodeId;
            const toPort = connector.dataset.port || 'input';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆè¿æ¥
            if (toNodeId !== connectionStart.nodeId) {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è¿æ¥
                const exists = connections.some(c => 
                    c.from === connectionStart.nodeId && 
                    c.to === toNodeId && 
                    c.fromPort === connectionStart.port
                );
                
                if (!exists) {
                    const connection = {
                        from: connectionStart.nodeId,
                        to: toNodeId,
                        fromPort: connectionStart.port,
                        toPort: toPort,
                        condition: connectionStart.condition,
                        label: connectionStart.condition === 'detected' ? 'æ£€æµ‹åˆ°' : 
                               connectionStart.condition === 'not_detected' ? 'æœªæ£€æµ‹åˆ°' : null
                    };
                    
                    connections.push(connection);
                    renderConnections();
                }
            }
        }
        
        isConnecting = false;
        connectionStart = null;
        document.removeEventListener('mouseup', endConnection);
    }

    function closeEditor() {
        if (confirm('ç¡®å®šè¦å…³é—­ç¼–è¾‘å™¨å—ï¼Ÿæœªä¿å­˜çš„æ›´æ”¹å°†ä¸¢å¤±ã€‚')) {
            document.getElementById('editorModal').classList.add('hidden');
            currentWorkflow = null;
            nodes = [];
            connections = [];
            selectedNode = null;
        }
    }

    async function saveWorkflow() {
        if (!currentWorkflow) return;
        
        const saveData = {
            workflow_data: {
                nodes: nodes,
                connections: connections
            }
        };
        
        console.log('ä¿å­˜å·¥ä½œæµæ•°æ®:', {
            nodes: nodes.length,
            connections: connections.length,
            data: saveData
        });
        
        try {
            await apiRequest(`/api/workflows/${currentWorkflow.id}`, 'PUT', saveData);
            
            showMessage('å·¥ä½œæµä¿å­˜æˆåŠŸ');
        } catch (error) {
            showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        }
    }

    async function activateWorkflow(id) {
        try {
            await apiRequest(`/api/workflows/${id}/activate`, 'POST');
            showMessage('å·¥ä½œæµå·²æ¿€æ´»');
            loadWorkflows();
        } catch (error) {
            showMessage('æ¿€æ´»å¤±è´¥: ' + error.message, 'error');
        }
    }

    async function deactivateWorkflow(id) {
        try {
            await apiRequest(`/api/workflows/${id}/deactivate`, 'POST');
            showMessage('å·¥ä½œæµå·²åœç”¨');
            loadWorkflows();
        } catch (error) {
            showMessage('åœç”¨å¤±è´¥: ' + error.message, 'error');
        }
    }

    async function deleteWorkflow(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå·¥ä½œæµå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
        
        try {
            await apiRequest(`/api/workflows/${id}`, 'DELETE');
            showMessage('å·¥ä½œæµåˆ é™¤æˆåŠŸ');
            loadWorkflows();
        } catch (error) {
            showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    loadWorkflows();
</script>
{% endblock %}

