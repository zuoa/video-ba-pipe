{% extends "base.html" %}

{% block title %}脚本管理{% endblock %}
{% block page_title %}脚本管理{% endblock %}
{% block page_subtitle %}管理自定义检测脚本{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- 顶部操作栏 -->
    <div class="flex justify-between items-center mb-8">
        <div class="flex items-center space-x-4">
            <div class="w-12 h-12 bg-black rounded-xl flex items-center justify-center text-white shadow-lg">
                <i class="fas fa-code text-xl"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-800">脚本列表</h3>
                <p class="text-sm text-gray-500" id="scriptCount">共 0 个脚本</p>
            </div>
        </div>
        <div class="flex items-center space-x-3">
            <a href="/scripts/templates" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors flex items-center space-x-2">
                <i class="fas fa-file-code"></i>
                <span>查看模板</span>
            </a>
            <button onclick="showUploadModal()" class="px-6 py-2 bg-black text-white rounded-lg font-medium shadow-lg hover:shadow-xl transition-all flex items-center space-x-2">
                <i class="fas fa-upload"></i>
                <span>上传脚本</span>
            </button>
        </div>
    </div>

    <!-- 分类标签 -->
    <div class="mb-6">
        <div class="flex space-x-2" id="categoryTabs">
            <button onclick="filterByCategory('')" class="category-tab active px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-category="">
                全部
            </button>
            <button onclick="filterByCategory('detectors')" class="category-tab px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-category="detectors">
                检测脚本
            </button>
            <button onclick="filterByCategory('filters')" class="category-tab px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-category="filters">
                过滤脚本
            </button>
            <button onclick="filterByCategory('hooks')" class="category-tab px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-category="hooks">
                Hook脚本
            </button>
            <button onclick="filterByCategory('postprocessors')" class="category-tab px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-category="postprocessors">
                后处理脚本
            </button>
        </div>
    </div>

    <!-- 脚本列表 -->
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-100">
                <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">路径</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">类别</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">名称</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">状态</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">操作</th>
                    </tr>
                </thead>
                <tbody id="scriptsTable" class="bg-white divide-y divide-gray-100">
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
                                <p class="text-gray-500">加载中...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 上传脚本模态框 -->
<div id="uploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
    <div class="relative top-10 mx-auto p-8 border border-gray-200 w-11/12 md:w-2/3 lg:w-1/2 shadow-2xl rounded-2xl bg-white">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-black rounded-lg flex items-center justify-center text-white">
                    <i class="fas fa-upload"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800">上传脚本</h3>
            </div>
            <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="uploadForm" class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">脚本路径</label>
                <input type="text" id="scriptPath" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent"
                       placeholder="例如: detectors/my_detector.py">
                <p class="mt-2 text-sm text-gray-500">相对于 app/user_scripts/ 的路径</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">脚本内容</label>
                <textarea id="scriptContent" rows="15" required
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-black focus:border-transparent"
                          placeholder="在此粘贴Python代码"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">类别</label>
                <select id="scriptCategory"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
                    <option value="detectors">检测脚本 (detectors)</option>
                    <option value="filters">过滤脚本 (filters)</option>
                    <option value="hooks">Hook脚本 (hooks)</option>
                    <option value="postprocessors">后处理脚本 (postprocessors)</option>
                </select>
            </div>

            <div class="flex items-center">
                <input type="checkbox" id="createAlgorithm" class="w-4 h-4 text-black border-gray-300 rounded focus:ring-black">
                <label for="createAlgorithm" class="ml-2 text-sm text-gray-700">同时创建算法记录</label>
            </div>
        </form>

        <div class="flex justify-end space-x-3 mt-8 pt-6 border-t border-gray-200">
            <button onclick="closeUploadModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                取消
            </button>
            <button onclick="uploadScript()" class="px-6 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors flex items-center space-x-2">
                <i class="fas fa-upload"></i>
                <span>上传</span>
            </button>
        </div>
    </div>
</div>

<!-- 编辑脚本模态框 -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
    <div class="relative top-10 mx-auto p-8 border border-gray-200 w-11/12 shadow-2xl rounded-2xl bg-white">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-black rounded-lg flex items-center justify-center text-white">
                    <i class="fas fa-edit"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-gray-800">编辑脚本</h3>
                    <p class="text-sm text-gray-500" id="editScriptPathDisplay"></p>
                </div>
            </div>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="editForm" class="space-y-6">
            <input type="hidden" id="editScriptPath">

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">脚本内容</label>
                <textarea id="editScriptContent" rows="20"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-black focus:border-transparent"
                          style="font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.5;"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">更新说明</label>
                <input type="text" id="editChangelog"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent"
                       placeholder="描述这次更新做了什么">
            </div>

            <div class="flex items-center">
                <input type="checkbox" id="createVersion" checked class="w-4 h-4 text-black border-gray-300 rounded focus:ring-black">
                <label for="createVersion" class="ml-2 text-sm text-gray-700">创建版本备份</label>
            </div>
        </form>

        <div class="flex justify-end space-x-3 mt-8 pt-6 border-t border-gray-200">
            <button onclick="closeEditModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                取消
            </button>
            <button onclick="validateCurrentScript()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center space-x-2">
                <i class="fas fa-check"></i>
                <span>验证</span>
            </button>
            <button onclick="saveScript()" class="px-6 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors flex items-center space-x-2">
                <i class="fas fa-save"></i>
                <span>保存</span>
            </button>
        </div>
    </div>
</div>

<!-- 验证结果模态框 -->
<div id="validationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
    <div class="relative top-20 mx-auto p-8 border border-gray-200 w-11/12 md:w-1/2 shadow-2xl rounded-2xl bg-white">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center text-white">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800">语法验证结果</h3>
            </div>
            <button onclick="closeValidationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div id="validationResult" class="space-y-3">
        </div>

        <div class="flex justify-end mt-8 pt-6 border-t border-gray-200">
            <button onclick="closeValidationModal()" class="px-6 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors">
                关闭
            </button>
        </div>
    </div>
</div>

<style>
.category-tab {
    background-color: #f3f4f6;
    color: #6b7280;
}

.category-tab:hover {
    background-color: #e5e7eb;
}

.category-tab.active {
    background-color: #000;
    color: #fff;
}

/* CodeMirror 自定义样式 */
.CodeMirror {
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    font-size: 13px;
    line-height: 1.5;
    height: auto;
    min-height: 400px;
}

.CodeMirror-scroll {
    min-height: 400px;
    max-height: 600px;
}
</style>

<script>
let currentCategory = '';
let allScripts = [];
let uploadEditor = null;
let editEditor = null;

// 页面加载时获取脚本列表
document.addEventListener('DOMContentLoaded', function() {
    loadScripts();

    // 初始化上传脚本编辑器
    uploadEditor = CodeMirror.fromTextArea(document.getElementById('scriptContent'), {
        mode: 'python',
        theme: 'monokai',
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        lineWrapping: true,
        autoCloseBrackets: true,
        styleActiveLine: true
    });

    // 初始化编辑脚本编辑器
    editEditor = CodeMirror.fromTextArea(document.getElementById('editScriptContent'), {
        mode: 'python',
        theme: 'monokai',
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        lineWrapping: true,
        autoCloseBrackets: true,
        styleActiveLine: true
    });
});

// 加载脚本列表
async function loadScripts() {
    const url = currentCategory ? `/api/scripts/?category=${currentCategory}` : '/api/scripts/';

    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
            allScripts = data.scripts;
            displayScripts(allScripts);
            updateScriptCount(allScripts.length);
        } else {
            showError('加载失败: ' + data.error);
        }
    } catch (error) {
        showError('加载失败，请检查网络连接');
        console.error(error);
    }
}

// 显示脚本列表
function displayScripts(scriptList) {
    if (scriptList.length === 0) {
        document.getElementById('scriptsTable').innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-12 text-center">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-folder-open text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">暂无脚本</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    let html = '';
    scriptList.forEach(function(script) {
        const statusBadge = script.status === 'active' ?
            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">已启用</span>' :
            script.status === 'available' ?
            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">可用</span>' :
            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">未注册</span>';

        html += `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4">
                    <code class="text-sm bg-gray-100 px-2 py-1 rounded">${script.path}</code>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        ${script.category || '未知'}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-900">${script.name}</td>
                <td class="px-6 py-4">${statusBadge}</td>
                <td class="px-6 py-4">
                    <div class="flex items-center space-x-2">
                        <button onclick="editScript('${script.path}')" class="text-gray-600 hover:text-black transition-colors" title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${script.algorithm_id ?
                            `<a href="/algorithms" class="text-gray-600 hover:text-black transition-colors" title="配置算法">
                                <i class="fas fa-cog"></i>
                            </a>` :
                            `<button onclick="createAlgorithmForScript('${script.path}')" class="text-gray-600 hover:text-green-600 transition-colors" title="注册算法">
                                <i class="fas fa-plus"></i>
                            </button>`
                        }
                        <button onclick="deleteScript('${script.path}')" class="text-gray-600 hover:text-red-600 transition-colors" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    document.getElementById('scriptsTable').innerHTML = html;
}

// 按类别筛选
function filterByCategory(category) {
    currentCategory = category;

    // 更新标签状态
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`.category-tab[data-category="${category}"]`).classList.add('active');

    loadScripts();
}

// 更新脚本计数
function updateScriptCount(count) {
    document.getElementById('scriptCount').textContent = `共 ${count} 个脚本`;
}

// 显示上传模态框
function showUploadModal() {
    document.getElementById('uploadModal').classList.remove('hidden');
}

// 关闭上传模态框
function closeUploadModal() {
    document.getElementById('uploadModal').classList.add('hidden');
    document.getElementById('uploadForm').reset();
    if (uploadEditor) {
        uploadEditor.setValue('');
    }
}

// 上传脚本
async function uploadScript() {
    const path = document.getElementById('scriptPath').value;
    const content = uploadEditor ? uploadEditor.getValue() : '';
    const category = document.getElementById('scriptCategory').value;
    const createAlgorithm = document.getElementById('createAlgorithm').checked;

    if (!path || !content) {
        alert('请填写脚本路径和内容');
        return;
    }

    try {
        const response = await fetch('/api/scripts/upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                path: path,
                content: content,
                category: category,
                create_algorithm: createAlgorithm
            })
        });

        const data = await response.json();

        if (data.success) {
            closeUploadModal();
            loadScripts();
            alert('脚本上传成功！');
        } else {
            alert('上传失败: ' + data.error);
        }
    } catch (error) {
        alert('上传失败，请检查网络连接');
        console.error(error);
    }
}

// 编辑脚本
async function editScript(path) {
    try {
        const response = await fetch(`/api/scripts/${encodeURIComponent(path)}`);
        const data = await response.json();

        if (data.success) {
            document.getElementById('editScriptPath').value = path;
            document.getElementById('editScriptPathDisplay').textContent = path;
            if (editEditor) {
                editEditor.setValue(data.script.content);
                editEditor.refresh();
            }
            document.getElementById('editModal').classList.remove('hidden');
        } else {
            alert('加载脚本失败: ' + data.error);
        }
    } catch (error) {
        alert('加载失败，请检查网络连接');
        console.error(error);
    }
}

// 关闭编辑模态框
function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    document.getElementById('editForm').reset();
    if (editEditor) {
        editEditor.setValue('');
    }
}

// 保存脚本
async function saveScript() {
    const path = document.getElementById('editScriptPath').value;
    const content = editEditor ? editEditor.getValue() : '';
    const changelog = document.getElementById('editChangelog').value;
    const createVersion = document.getElementById('createVersion').checked;

    try {
        const response = await fetch(`/api/scripts/${encodeURIComponent(path)}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                content: content,
                changelog: changelog,
                create_version: createVersion
            })
        });

        const data = await response.json();

        if (data.success) {
            closeEditModal();
            loadScripts();
            alert('脚本保存成功！');
        } else {
            alert('保存失败: ' + data.error);
        }
    } catch (error) {
        alert('保存失败，请检查网络连接');
        console.error(error);
    }
}

// 验证当前编辑的脚本
function validateCurrentScript() {
    const content = editEditor ? editEditor.getValue() : '';
    validateScriptContent(content);
}

// 验证脚本内容
async function validateScriptContent(content) {
    try {
        const response = await fetch('/api/scripts/validate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: content })
        });

        const data = await response.json();

        if (data.success) {
            const v = data.validation;
            let html = '<div class="space-y-2">';

            html += createValidationItem('语法检查', v.syntax_valid, v.syntax_error);
            html += createValidationItem('process函数', v.has_process, false);
            html += createValidationItem('init函数', v.has_init, false, true);
            html += createValidationItem('cleanup函数', v.has_cleanup, false, true);
            html += createValidationItem('SCRIPT_METADATA', v.has_metadata, false);
            html += createValidationItem('整体评估', v.is_valid, false);

            html += '</div>';
            document.getElementById('validationResult').innerHTML = html;
            document.getElementById('validationModal').classList.remove('hidden');
        }
    } catch (error) {
        alert('验证失败，请检查网络连接');
        console.error(error);
    }
}

// 创建验证项显示
function createValidationItem(label, passed, error, optional = false) {
    let statusIcon = '';
    let statusClass = '';

    if (passed) {
        statusIcon = '<i class="fas fa-check-circle"></i>';
        statusClass = 'text-green-600';
    } else if (optional) {
        statusIcon = '<i class="fas fa-minus-circle"></i>';
        statusClass = 'text-gray-400';
    } else {
        statusIcon = '<i class="fas fa-times-circle"></i>';
        statusClass = 'text-red-600';
    }

    let html = `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <span class="font-medium text-gray-700">${label}</span>
            <span class="${statusClass}">${statusIcon}</span>
        </div>
    `;

    if (error && !passed) {
        html += `<p class="ml-4 text-sm text-red-600 mt-1">第 ${error.line} 行: ${error.message}</p>`;
    }

    return html;
}

// 关闭验证模态框
function closeValidationModal() {
    document.getElementById('validationModal').classList.add('hidden');
}

// 删除脚本
async function deleteScript(path) {
    if (!confirm(`确定要删除脚本 ${path} 吗？`)) {
        return;
    }

    try {
        const response = await fetch(`/api/scripts/${encodeURIComponent(path)}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            loadScripts();
            alert('脚本已删除');
        } else {
            alert('删除失败: ' + data.error);
        }
    } catch (error) {
        alert('删除失败，请检查网络连接');
        console.error(error);
    }
}

// 为脚本创建算法记录
function createAlgorithmForScript(path) {
    window.location.href = `/algorithms?script_path=${encodeURIComponent(path)}`;
}

// 显示错误
function showError(message) {
    document.getElementById('scriptsTable').innerHTML = `
        <tr>
            <td colspan="5" class="px-6 py-12 text-center">
                <div class="flex flex-col items-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                    <p class="text-red-600">${message}</p>
                </div>
            </td>
        </tr>
    `;
}
</script>
{% endblock %}
