{% extends "base.html" %}

{% block title %}算法配置向导{% endblock %}
{% block page_title %}算法配置向导{% endblock %}
{% block page_subtitle %}分步引导创建算法配置{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- 进度指示器 -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="relative">
                    <!-- 进度条背景 -->
                    <div class="h-2 bg-gray-200 rounded-full"></div>
                    <!-- 进度条 -->
                    <div id="progressBar" class="h-2 bg-black rounded-full transition-all duration-300" style="width: 33.33%"></div>
                </div>
            </div>
        </div>
        
        <!-- 步骤标签 -->
        <div class="flex justify-between mt-4">
            <div class="flex flex-col items-center flex-1">
                <div id="step1Indicator" class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center font-bold shadow-lg">
                    1
                </div>
                <span class="text-sm mt-2 font-medium">选择检测器</span>
            </div>
            <div class="flex flex-col items-center flex-1">
                <div id="step2Indicator" class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold">
                    2
                </div>
                <span class="text-sm mt-2 text-gray-500">配置参数</span>
            </div>
            <div class="flex flex-col items-center flex-1">
                <div id="step3Indicator" class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold">
                    3
                </div>
                <span class="text-sm mt-2 text-gray-500">执行配置</span>
            </div>
        </div>
    </div>

    <!-- 向导内容卡片 -->
    <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
        
        <!-- ========== 步骤 1: 选择检测器类型 ========== -->
        <div id="step1Content" class="wizard-step">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">选择检测器类型</h2>
            
            <!-- 系统模板 -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                    <i class="fas fa-star text-yellow-500 mr-2"></i>
                    系统模板（推荐）
                </h3>
                <div id="systemTemplates" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- 动态加载 -->
                </div>
            </div>
            
            <!-- 我的脚本 -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                    <i class="fas fa-code text-blue-500 mr-2"></i>
                    我的脚本
                </h3>
                <div id="userScripts" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- 动态加载 -->
                </div>
            </div>
            
            <!-- 上传新脚本 -->
            <div>
                <button onclick="window.open('/scripts', '_blank')" class="w-full p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">
                    <i class="fas fa-upload text-gray-400 text-2xl mb-2"></i>
                    <p class="text-gray-600 font-medium">上传新脚本</p>
                    <p class="text-sm text-gray-400">管理自定义检测脚本</p>
                </button>
            </div>
        </div>
        
        <!-- ========== 步骤 2: 配置检测器参数 ========== -->
        <div id="step2Content" class="wizard-step hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">配置检测器参数</h2>
            
            <!-- 选中的检测器信息 -->
            <div id="selectedDetectorInfo" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-500 text-xl mt-1 mr-3"></i>
                    <div>
                        <h4 class="font-semibold text-gray-800" id="detectorNameDisplay"></h4>
                        <p class="text-sm text-gray-600 mt-1" id="detectorDescDisplay"></p>
                    </div>
                </div>
            </div>
            
            <!-- 动态配置表单 -->
            <div id="dynamicConfigForm">
                <!-- 根据脚本的 SCRIPT_METADATA.config_schema 动态生成 -->
            </div>
        </div>
        
        <!-- ========== 步骤 3: 执行和告警配置 ========== -->
        <div id="step3Content" class="wizard-step hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">执行和告警配置</h2>
            
            <div class="space-y-6">
                <!-- 基础信息 -->
                <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
                    <h3 class="font-semibold text-gray-700 mb-4">基础信息</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">算法名称 *</label>
                            <input type="text" id="algorithmName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent" placeholder="例如: 门口人员检测">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">检测间隔（秒）</label>
                            <input type="number" id="intervalSeconds" value="1" step="0.1" min="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
                        </div>
                    </div>
                </div>
                
                <!-- 性能配置 -->
                <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
                    <h3 class="font-semibold text-gray-700 mb-4">性能配置</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">运行超时（秒）</label>
                            <input type="number" id="runtimeTimeout" value="30" min="1" max="300" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">内存限制（MB）</label>
                            <input type="number" id="memoryLimit" value="512" min="64" max="4096" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
                        </div>
                    </div>
                </div>
                
                <!-- 时间窗口配置 -->
                <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="enableWindowCheck" class="w-5 h-5 text-black border-gray-300 rounded focus:ring-black mr-3">
                        <label for="enableWindowCheck" class="font-semibold text-gray-700 cursor-pointer">启用时间窗口检测（误报抑制）</label>
                    </div>
                    
                    <div id="windowConfigFields" class="space-y-4 hidden">
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">窗口大小（秒）</label>
                                <input type="number" id="windowSize" value="30" min="5" max="300" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">预警模式</label>
                                <select id="windowMode" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="ratio">占比模式</option>
                                    <option value="count">次数模式</option>
                                    <option value="consecutive">连续模式</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">预警阈值</label>
                                <input type="number" id="windowThreshold" value="0.3" step="0.1" min="0" max="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 标签配置 -->
                <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
                    <h3 class="font-semibold text-gray-700 mb-4">显示标签</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">标签名称</label>
                            <input type="text" id="labelName" value="Object" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">标签颜色</label>
                            <input type="color" id="labelColor" value="#FF0000" class="w-full h-10 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 导航按钮 -->
        <div class="flex justify-between mt-8 pt-6 border-t border-gray-200">
            <button id="prevBtn" onclick="previousStep()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all hidden">
                <i class="fas fa-arrow-left mr-2"></i>
                上一步
            </button>
            <div class="flex-1"></div>
            <button id="nextBtn" onclick="nextStep()" class="px-6 py-3 bg-black text-white rounded-lg font-medium hover:bg-gray-800 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                下一步
                <i class="fas fa-arrow-right ml-2"></i>
            </button>
            <button id="submitBtn" onclick="submitWizard()" class="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-all hidden">
                <i class="fas fa-check mr-2"></i>
                创建算法
            </button>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
let selectedDetector = null;
let scriptConfig = {};

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    loadSystemTemplates();
    loadUserScripts();
    
    // 时间窗口开关
    document.getElementById('enableWindowCheck').addEventListener('change', function() {
        document.getElementById('windowConfigFields').classList.toggle('hidden', !this.checked);
    });
});

// 加载系统模板
async function loadSystemTemplates() {
    try {
        console.log('开始加载系统模板...');
        const response = await fetch('/api/detector-templates?is_system=true');
        console.log('API响应状态:', response.status);
        
        const data = await response.json();
        console.log('API返回数据:', data);
        
        if (data.success && data.templates && data.templates.length > 0) {
            const container = document.getElementById('systemTemplates');
            container.innerHTML = data.templates.map(template => `
                <div class="template-card border-2 border-gray-200 rounded-lg p-4 hover:border-black hover:shadow-lg transition-all cursor-pointer" onclick="selectDetector('template', ${template.id}, '${escapeJs(template.name)}', '${escapeJs(template.description)}', '${escapeJs(template.script_path)}')">
                    <div class="flex items-start">
                        <i class="fas fa-brain text-2xl text-black mr-3"></i>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">${escapeHtml(template.name)}</h4>
                            <p class="text-sm text-gray-600 mt-1">${escapeHtml(template.description)}</p>
                            <div class="flex flex-wrap gap-1 mt-2">
                                ${template.tags_list ? template.tags_list.map(tag => `<span class="text-xs bg-gray-100 px-2 py-1 rounded">${escapeHtml(tag)}</span>`).join('') : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            console.log(`成功加载 ${data.templates.length} 个系统模板`);
        } else {
            console.warn('没有找到系统模板，返回数据:', data);
            const container = document.getElementById('systemTemplates');
            container.innerHTML = '<p class="text-gray-400 text-center col-span-2">暂无系统模板，请联系管理员初始化</p>';
        }
    } catch (error) {
        console.error('加载系统模板失败:', error);
        const container = document.getElementById('systemTemplates');
        container.innerHTML = `<p class="text-red-400 text-center col-span-2">加载失败: ${error.message}</p>`;
    }
}

// HTML转义函数
function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// JavaScript字符串转义函数
function escapeJs(str) {
    if (!str) return '';
    return str.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
}

// 加载用户脚本
async function loadUserScripts() {
    try {
        const response = await fetch('/api/scripts?category=detectors');
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('userScripts');
            if (data.scripts.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center col-span-2">暂无自定义脚本</p>';
            } else {
                container.innerHTML = data.scripts.map(script => `
                    <div class="template-card border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 hover:shadow-lg transition-all cursor-pointer" onclick="selectDetector('script', null, '${script.name}', '自定义脚本', '${script.path}')">
                        <div class="flex items-start">
                            <i class="fas fa-code text-2xl text-blue-500 mr-3"></i>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">${script.name}</h4>
                                <p class="text-sm text-gray-600 mt-1">${script.path}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
    } catch (error) {
        console.error('加载用户脚本失败:', error);
    }
}

// 选择检测器
function selectDetector(type, id, name, description, scriptPath) {
    selectedDetector = { type, id, name, description, scriptPath };
    
    // 移除所有选中状态
    document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('border-black', 'bg-blue-50', 'border-blue-500');
    });
    
    // 添加选中状态
    event.currentTarget.classList.add(type === 'template' ? 'border-black' : 'border-blue-500');
    event.currentTarget.classList.add(type === 'template' ? 'bg-gray-50' : 'bg-blue-50');
    
    // 启用下一步按钮
    document.getElementById('nextBtn').disabled = false;
}

// 下一步
async function nextStep() {
    if (currentStep === 1) {
        if (!selectedDetector) {
            alert('请先选择一个检测器');
            return;
        }
        
        // 加载脚本的配置模式
        await loadScriptConfigSchema(selectedDetector.scriptPath);
        
        // 保存配置模式供后续使用
        currentStep++;
        updateWizardUI();
    } else if (currentStep === 2) {
        // 验证配置
        if (!validateConfigForm()) {
            return;
        }
        currentStep++;
        updateWizardUI();
    }
}

// 上一步
function previousStep() {
    currentStep--;
    updateWizardUI();
}

// 更新向导UI
function updateWizardUI() {
    // 更新进度条
    const progress = (currentStep / 3) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    
    // 更新步骤指示器
    for (let i = 1; i <= 3; i++) {
        const indicator = document.getElementById(`step${i}Indicator`);
        if (i < currentStep) {
            indicator.className = 'w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold shadow-lg';
            indicator.innerHTML = '<i class="fas fa-check"></i>';
        } else if (i === currentStep) {
            indicator.className = 'w-10 h-10 rounded-full bg-black text-white flex items-center justify-center font-bold shadow-lg';
            indicator.innerHTML = i;
        } else {
            indicator.className = 'w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold';
            indicator.innerHTML = i;
        }
    }
    
    // 显示/隐藏步骤内容
    document.querySelectorAll('.wizard-step').forEach((step, index) => {
        step.classList.toggle('hidden', index + 1 !== currentStep);
    });
    
    // 更新按钮
    document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);
    document.getElementById('nextBtn').classList.toggle('hidden', currentStep === 3);
    document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== 3);
    
    // 滚动到顶部
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// 加载脚本配置模式
async function loadScriptConfigSchema(scriptPath) {
    // 显示检测器信息
    document.getElementById('detectorNameDisplay').textContent = selectedDetector.name;
    document.getElementById('detectorDescDisplay').textContent = selectedDetector.description;
    
    try {
        // 从后端API获取脚本的配置模式
        const encodedPath = encodeURIComponent(scriptPath);
        const response = await fetch(`/api/detector-templates/script-config/${encodedPath}`);
        const data = await response.json();
        
        if (data.success) {
            const configSchema = data.config_schema || {};
            
            // 保存配置模式供后续使用
            window.currentConfigSchema = configSchema;
            
            generateConfigForm(configSchema);
        } else {
            throw new Error(data.error || '获取配置模式失败');
        }
    } catch (error) {
        console.error('加载配置模式失败:', error);
        // 显示错误信息
        const container = document.getElementById('dynamicConfigForm');
        container.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                <span class="text-red-700">无法加载配置模式: ${error.message}</span>
            </div>
        `;
    }
}

// 生成配置表单
function generateConfigForm(schema) {
    const container = document.getElementById('dynamicConfigForm');
    
    if (!schema || Object.keys(schema).length === 0) {
        container.innerHTML = `
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
                <i class="fas fa-info-circle text-gray-400 text-2xl mb-2"></i>
                <p class="text-gray-600">此检测器无需额外配置</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    for (const [key, field] of Object.entries(schema)) {
        html += generateFieldHtml(key, field);
    }
    
    container.innerHTML = html;
    
    // 初始化所有组件
    initializeFormComponents();
}

// 生成单个字段的HTML
function generateFieldHtml(key, field) {
    const fieldType = field.type;
    const label = field.label || key;
    const description = field.description || '';
    const required = field.required || false;
    const defaultValue = field.default !== undefined ? field.default : '';
    
    let html = `
        <div class="mb-6 border border-gray-200 rounded-lg p-4 bg-gray-50" data-field="${key}">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
                ${label}
                ${required ? '<span class="text-red-500">*</span>' : ''}
            </label>
    `;
    
    if (description) {
        html += `<p class="text-xs text-gray-500 mb-3">${description}</p>`;
    }
    
    switch (fieldType) {
        case 'model_list':
            html += generateModelListField(key, field);
            break;
        case 'model_select':
            html += generateModelSelectField(key, field);
            break;
        case 'float':
            html += generateFloatField(key, field);
            break;
        case 'int':
            html += generateIntField(key, field);
            break;
        case 'int_list':
            html += generateIntListField(key, field);
            break;
        case 'string':
            html += generateStringField(key, field);
            break;
        case 'select':
            html += generateSelectField(key, field);
            break;
        case 'boolean':
            html += generateBooleanField(key, field);
            break;
        case 'color':
            html += generateColorField(key, field);
            break;
        default:
            html += `<input type="text" id="config_${key}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="${defaultValue}">`;
    }
    
    html += `</div>`;
    return html;
}

// 生成模型列表字段
function generateModelListField(key, field) {
    const multiple = field.multiple || false;
    const itemSchema = field.item_schema || {};
    
    return `
        <div id="modelList_${key}" class="space-y-3">
            <!-- 模型项将动态添加到这里 -->
        </div>
        <button type="button" onclick="addModelItem('${key}')" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all flex items-center">
            <i class="fas fa-plus mr-2"></i>
            添加模型
        </button>
    `;
}

// 生成单一模型选择字段
function generateModelSelectField(key, field) {
    return `
        <select id="config_${key}" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-black focus:border-transparent"
                data-field-type="model_select">
            <option value="">选择模型...</option>
            <!-- 模型选项将在初始化时异步加载 -->
        </select>
    `;
}

// 生成整数列表字段
function generateIntListField(key, field) {
    const defaultValue = field.default ? JSON.stringify(field.default) : '[]';
    const placeholder = field.placeholder || '例如: [0, 1, 2]';
    
    return `
        <input type="text" 
               id="config_${key}" 
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent font-mono text-sm" 
               value='${defaultValue}'
               placeholder="${placeholder}">
        <p class="text-xs text-gray-500 mt-1">输入JSON数组格式，例如: [0, 1, 2]</p>
    `;
}

// 生成浮点数字段
function generateFloatField(key, field) {
    const min = field.min !== undefined ? field.min : '';
    const max = field.max !== undefined ? field.max : '';
    const step = field.step !== undefined ? field.step : '0.01';
    const defaultValue = field.default !== undefined ? field.default : '';
    
    return `
        <input type="number" 
               id="config_${key}" 
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent" 
               value="${defaultValue}"
               ${min !== '' ? `min="${min}"` : ''}
               ${max !== '' ? `max="${max}"` : ''}
               step="${step}">
    `;
}

// 生成整数字段
function generateIntField(key, field) {
    const min = field.min !== undefined ? field.min : '';
    const max = field.max !== undefined ? field.max : '';
    const defaultValue = field.default !== undefined ? field.default : '';
    
    return `
        <input type="number" 
               id="config_${key}" 
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent" 
               value="${defaultValue}"
               ${min !== '' ? `min="${min}"` : ''}
               ${max !== '' ? `max="${max}"` : ''}
               step="1">
    `;
}

// 生成字符串字段
function generateStringField(key, field) {
    const defaultValue = field.default !== undefined ? field.default : '';
    const placeholder = field.placeholder || '';
    
    return `
        <input type="text" 
               id="config_${key}" 
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent" 
               value="${defaultValue}"
               placeholder="${placeholder}">
    `;
}

// 生成选择字段
function generateSelectField(key, field) {
    const options = field.options || [];
    const defaultValue = field.default !== undefined ? field.default : '';
    
    let html = `<select id="config_${key}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-black focus:border-transparent">`;
    
    options.forEach(option => {
        const value = typeof option === 'object' ? option.value : option;
        const label = typeof option === 'object' ? option.label : option;
        const selected = value === defaultValue ? 'selected' : '';
        html += `<option value="${value}" ${selected}>${label}</option>`;
    });
    
    html += `</select>`;
    return html;
}

// 生成布尔字段
function generateBooleanField(key, field) {
    const defaultValue = field.default || false;
    const checked = defaultValue ? 'checked' : '';
    
    return `
        <label class="flex items-center cursor-pointer">
            <input type="checkbox" 
                   id="config_${key}" 
                   class="w-5 h-5 text-black border-gray-300 rounded focus:ring-black mr-3"
                   ${checked}>
            <span class="text-sm text-gray-600">${field.label || key}</span>
        </label>
    `;
}

// 生成颜色字段
function generateColorField(key, field) {
    const defaultValue = field.default || '#FF0000';
    
    return `
        <input type="color" 
               id="config_${key}" 
               class="w-full h-10 border border-gray-300 rounded-lg cursor-pointer" 
               value="${defaultValue}">
    `;
}

// 初始化表单组件
let modelItems = {}; // 存储每个字段的模型项

async function initializeFormComponents() {
    // 初始化模型列表
    const schema = getCurrentSchema();
    for (const [key, field] of Object.entries(schema)) {
        if (field.type === 'model_list') {
            modelItems[key] = [];
            // 自动添加一个模型项
            addModelItem(key);
        } else if (field.type === 'model_select') {
            // 加载模型选择下拉框
            await loadModelsForSelect(key, field);
        }
    }
}

// 为单一模型选择字段加载模型列表
async function loadModelsForSelect(fieldKey, field) {
    const selectElement = document.getElementById(`config_${fieldKey}`);
    if (!selectElement) return;
    
    try {
        const response = await fetch('/api/models');
        const data = await response.json();
        
        if (data.success && data.models) {
            // 应用过滤器（如果有）
            let models = data.models.filter(m => m.enabled);
            
            if (field.filters) {
                if (field.filters.model_type) {
                    models = models.filter(m => field.filters.model_type.includes(m.model_type));
                }
                if (field.filters.framework) {
                    models = models.filter(m => field.filters.framework.includes(m.framework));
                }
            }
            
            // 生成选项
            const options = models.map(m => 
                `<option value="${m.id}">${m.name} (${m.model_type})</option>`
            ).join('');
            
            // 保留"选择模型..."选项，添加模型选项
            selectElement.innerHTML = '<option value="">选择模型...</option>' + options;
        }
    } catch (error) {
        console.error('加载模型列表失败:', error);
    }
}

// 获取当前的配置模式
function getCurrentSchema() {
    // 这个函数需要保存配置模式，以便后续使用
    return window.currentConfigSchema || {};
}

// 添加模型项
async function addModelItem(fieldKey) {
    const container = document.getElementById(`modelList_${fieldKey}`);
    if (!container) return;
    
    const itemId = `model_item_${fieldKey}_${Date.now()}`;
    const schema = getCurrentSchema();
    const field = schema[fieldKey];
    const itemSchema = field.item_schema || {};
    
    // 加载可用模型列表
    let modelOptions = '<option value="">选择模型...</option>';
    try {
        const response = await fetch('/api/models');
        const data = await response.json();
        if (data.success && data.models) {
            modelOptions += data.models
                .filter(m => m.enabled)
                .map(m => `<option value="${m.id}">${m.name} (${m.model_type})</option>`)
                .join('');
        }
    } catch (error) {
        console.error('加载模型列表失败:', error);
    }
    
    let html = `
        <div id="${itemId}" class="border border-blue-200 rounded-lg p-4 bg-white">
            <div class="flex justify-between items-center mb-3">
                <h4 class="font-semibold text-gray-700">模型 #${modelItems[fieldKey] ? modelItems[fieldKey].length + 1 : 1}</h4>
                <button type="button" onclick="removeModelItem('${itemId}', '${fieldKey}')" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="space-y-3">
    `;
    
    // 生成模型项的子字段
    for (const [subKey, subField] of Object.entries(itemSchema)) {
        const subLabel = subField.label || subKey;
        const subType = subField.type;
        const subDefault = subField.default !== undefined ? subField.default : '';
        
        html += `<div>`;
        html += `<label class="block text-xs font-medium text-gray-600 mb-1">${subLabel}</label>`;
        
        switch (subType) {
            case 'model_select':
                html += `<select class="model-item-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white" data-field="${subKey}" data-item-id="${itemId}">${modelOptions}</select>`;
                break;
            case 'float':
                html += `<input type="number" class="model-item-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" data-field="${subKey}" data-item-id="${itemId}" value="${subDefault}" min="${subField.min || 0}" max="${subField.max || 1}" step="${subField.step || 0.01}">`;
                break;
            case 'int':
                html += `<input type="number" class="model-item-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" data-field="${subKey}" data-item-id="${itemId}" value="${subDefault}" min="${subField.min || 0}" step="1">`;
                break;
            case 'string':
                html += `<input type="text" class="model-item-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" data-field="${subKey}" data-item-id="${itemId}" value="${subDefault}">`;
                break;
            case 'color':
                html += `<input type="color" class="model-item-field w-full h-8 border border-gray-300 rounded-lg cursor-pointer" data-field="${subKey}" data-item-id="${itemId}" value="${subDefault}">`;
                break;
            default:
                html += `<input type="text" class="model-item-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" data-field="${subKey}" data-item-id="${itemId}" value="${subDefault}">`;
        }
        
        html += `</div>`;
    }
    
    html += `</div></div>`;
    
    container.insertAdjacentHTML('beforeend', html);
    
    if (!modelItems[fieldKey]) {
        modelItems[fieldKey] = [];
    }
    modelItems[fieldKey].push(itemId);
}

// 移除模型项
function removeModelItem(itemId, fieldKey) {
    const element = document.getElementById(itemId);
    if (element) {
        element.remove();
    }
    
    if (modelItems[fieldKey]) {
        modelItems[fieldKey] = modelItems[fieldKey].filter(id => id !== itemId);
    }
}

// 验证配置表单
function validateConfigForm() {
    const schema = getCurrentSchema();
    
    for (const [key, field] of Object.entries(schema)) {
        if (field.required) {
            if (field.type === 'model_list') {
                // 验证模型列表
                const items = collectModelItems(key);
                if (items.length === 0) {
                    alert(`请至少添加一个${field.label || key}`);
                    return false;
                }
                
                // 验证每个模型项
                for (const item of items) {
                    if (!item.model_id) {
                        alert(`请为所有${field.label || key}选择模型`);
                        return false;
                    }
                }
            } else if (field.type === 'model_select') {
                // 验证单一模型选择
                const input = document.getElementById(`config_${key}`);
                if (!input || !input.value || input.value === '') {
                    alert(`请选择${field.label || key}`);
                    return false;
                }
            } else if (field.type === 'int_list') {
                // 验证整数列表格式
                const input = document.getElementById(`config_${key}`);
                if (input && input.value) {
                    try {
                        const parsed = JSON.parse(input.value);
                        if (!Array.isArray(parsed)) {
                            alert(`${field.label || key}必须是数组格式，例如: [0, 1, 2]`);
                            return false;
                        }
                    } catch (e) {
                        alert(`${field.label || key}格式错误，请输入有效的JSON数组，例如: [0, 1, 2]`);
                        return false;
                    }
                }
            } else {
                // 验证普通字段
                const input = document.getElementById(`config_${key}`);
                if (!input) continue;
                
                const value = input.type === 'checkbox' ? input.checked : input.value;
                if (!value && value !== 0 && value !== false) {
                    alert(`请填写必填字段: ${field.label || key}`);
                    return false;
                }
            }
        }
    }
    
    // 收集配置数据
    scriptConfig = collectConfigData();
    
    return true;
}

// 收集配置数据
function collectConfigData() {
    const schema = getCurrentSchema();
    const config = {};
    
    for (const [key, field] of Object.entries(schema)) {
        if (field.type === 'model_list') {
            config[key] = collectModelItems(key);
        } else {
            const input = document.getElementById(`config_${key}`);
            if (input) {
                if (input.type === 'checkbox') {
                    config[key] = input.checked;
                } else if (input.type === 'number') {
                    config[key] = parseFloat(input.value);
                } else if (field.type === 'model_select') {
                    // 模型选择字段，转换为整数ID
                    config[key] = input.value ? parseInt(input.value) : null;
                } else if (field.type === 'int_list') {
                    // 整数列表字段，解析JSON
                    try {
                        config[key] = input.value ? JSON.parse(input.value) : [];
                    } catch (e) {
                        console.warn(`解析整数列表失败 (${key}):`, e);
                        config[key] = [];
                    }
                } else {
                    config[key] = input.value;
                }
            }
        }
    }
    
    return config;
}

// 收集模型项数据
function collectModelItems(fieldKey) {
    const items = [];
    const itemIds = modelItems[fieldKey] || [];
    
    for (const itemId of itemIds) {
        const item = {};
        const fields = document.querySelectorAll(`[data-item-id="${itemId}"]`);
        
        fields.forEach(field => {
            const fieldName = field.getAttribute('data-field');
            if (field.type === 'number') {
                item[fieldName] = parseFloat(field.value);
            } else if (field.type === 'checkbox') {
                item[fieldName] = field.checked;
            } else {
                item[fieldName] = field.value;
            }
        });
        
        items.push(item);
    }
    
    return items;
}

// 提交向导
async function submitWizard() {
    const algorithmName = document.getElementById('algorithmName').value;
    
    // 验证必填字段
    if (!algorithmName) {
        alert('请输入算法名称');
        return;
    }
    
    const algorithmData = {
        name: algorithmName,
        script_path: selectedDetector.scriptPath,
        script_config: JSON.stringify(scriptConfig),
        detector_template_id: selectedDetector.type === 'template' ? selectedDetector.id : null,
        interval_seconds: parseFloat(document.getElementById('intervalSeconds').value),
        runtime_timeout: parseInt(document.getElementById('runtimeTimeout').value),
        memory_limit_mb: parseInt(document.getElementById('memoryLimit').value),
        enable_window_check: document.getElementById('enableWindowCheck').checked,
        window_size: parseInt(document.getElementById('windowSize').value),
        window_mode: document.getElementById('windowMode').value,
        window_threshold: parseFloat(document.getElementById('windowThreshold').value),
        label_name: document.getElementById('labelName').value,
        label_color: document.getElementById('labelColor').value
    };
    
    try {
        // 使用正确的API端点
        const response = await fetch('/api/algorithms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(algorithmData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('算法创建成功！');
            window.location.href = '/algorithms';
        } else {
            alert('创建失败: ' + (data.error || '未知错误'));
        }
    } catch (error) {
        console.error('提交失败:', error);
        alert('提交失败: ' + error.message);
    }
}
</script>

<style>
.wizard-step {
    min-height: 400px;
}

.template-card {
    transition: all 0.2s;
}

.template-card:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}

