{% extends "base.html" %}

{% block title %}告警记录{% endblock %}

{% block content %}
<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">告警记录</h1>
        <div class="flex space-x-4">
            <select id="taskFilter" onchange="loadAlerts(1)" class="px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                <option value="">所有任务</option>
            </select>
            <button onclick="loadAlerts(currentPage)" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                刷新
            </button>
        </div>
    </div>

    <!-- 顶部分页组件 -->
    <div id="paginationContainerTop" class="hidden mb-4 flex justify-between items-center bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-600">
            共 <span class="totalRecords">0</span> 条记录，每页 
            <select class="perPageSelect" onchange="changePerPage()" class="mx-1 px-2 py-1 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                <option value="10">10</option>
                <option value="30" selected>30</option>
                <option value="60">60</option>
                <option value="120">120</option>
            </select>
            条
        </div>
        <div class="flex items-center space-x-2">
            <button onclick="goToPage(1)" class="firstPageBtn px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                首页
            </button>
            <button onclick="goToPage(currentPage - 1)" class="prevPageBtn px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                上一页
            </button>
            <div class="flex items-center space-x-1 pageNumbers">
            </div>
            <button onclick="goToPage(currentPage + 1)" class="nextPageBtn px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                下一页
            </button>
            <button onclick="goToPage(totalPages)" class="lastPageBtn px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                末页
            </button>
        </div>
        <div class="text-sm text-gray-600">
            第 <span class="currentPageDisplay">1</span> / <span class="totalPagesDisplay">1</span> 页
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="alertsContainer">
    </div>

    <div id="noAlerts" class="hidden bg-white rounded-lg shadow p-8 text-center">
        <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
        </svg>
        <p class="text-gray-600 text-lg">暂无告警记录</p>
    </div>

    <!-- 底部分页组件 -->
    <div id="paginationContainerBottom" class="hidden mt-6 flex justify-between items-center bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-600">
            共 <span class="totalRecords">0</span> 条记录，每页 
            <select class="perPageSelect" onchange="changePerPage()" class="mx-1 px-2 py-1 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                <option value="10">10</option>
                <option value="30" selected>30</option>
                <option value="60">60</option>
                <option value="120">120</option>
            </select>
            条
        </div>
        <div class="flex items-center space-x-2">
            <button onclick="goToPage(1)" class="firstPageBtn px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                首页
            </button>
            <button onclick="goToPage(currentPage - 1)" class="prevPageBtn px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                上一页
            </button>
            <div class="flex items-center space-x-1 pageNumbers">
            </div>
            <button onclick="goToPage(currentPage + 1)" class="nextPageBtn px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                下一页
            </button>
            <button onclick="goToPage(totalPages)" class="lastPageBtn px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                末页
            </button>
        </div>
        <div class="text-sm text-gray-600">
            第 <span class="currentPageDisplay">1</span> / <span class="totalPagesDisplay">1</span> 页
        </div>
    </div>
</div>

<!-- 告警详情模态框 -->
<div id="alertDetailModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">告警详情</h3>
            <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <div id="alertDetailContent" class="space-y-4">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let alerts = [];
    let tasks = [];
    let currentPage = 1;
    let perPage = 30;
    let totalPages = 1;
    let totalRecords = 0;

    async function loadTasks() {
        try {
            tasks = await apiRequest('/api/tasks');
            const select = document.getElementById('taskFilter');
            tasks.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.name;
                select.appendChild(option);
            });
        } catch (error) {
            showMessage('加载任务列表失败: ' + error.message, 'error');
        }
    }

    async function loadAlerts(page = 1) {
        currentPage = page;
        const taskId = document.getElementById('taskFilter').value;
        let url = `/api/alerts?page=${page}&per_page=${perPage}`;
        if (taskId) {
            url += `&task_id=${taskId}`;
        }

        try {
            const response = await apiRequest(url);
            alerts = response.data;
            totalRecords = response.pagination.total;
            totalPages = response.pagination.total_pages;
            currentPage = response.pagination.page;
            perPage = response.pagination.per_page;
            
            renderAlerts();
            renderPagination();
        } catch (error) {
            showMessage('加载告警记录失败: ' + error.message, 'error');
        }
    }

    function goToPage(page) {
        if (page < 1 || page > totalPages || page === currentPage) return;
        loadAlerts(page);
    }

    function changePerPage() {
        const selects = document.querySelectorAll('.perPageSelect');
        perPage = parseInt(selects[0].value);
        loadAlerts(1); // 改变每页数量时回到第一页
    }

    function renderPagination() {
        const paginationTop = document.getElementById('paginationContainerTop');
        const paginationBottom = document.getElementById('paginationContainerBottom');
        
        // 如果没有数据，隐藏分页
        if (totalRecords === 0) {
            paginationTop.classList.add('hidden');
            paginationBottom.classList.add('hidden');
            return;
        }
        paginationTop.classList.remove('hidden');
        paginationBottom.classList.remove('hidden');

        // 更新统计信息（所有分页器）
        document.querySelectorAll('.totalRecords').forEach(el => el.textContent = totalRecords);
        document.querySelectorAll('.currentPageDisplay').forEach(el => el.textContent = currentPage);
        document.querySelectorAll('.totalPagesDisplay').forEach(el => el.textContent = totalPages);

        // 更新每页数量选择器
        document.querySelectorAll('.perPageSelect').forEach(select => {
            select.value = perPage;
        });

        // 更新按钮状态（所有分页器）
        const isFirstPage = currentPage === 1;
        const isLastPage = currentPage === totalPages;
        
        document.querySelectorAll('.firstPageBtn').forEach(btn => btn.disabled = isFirstPage);
        document.querySelectorAll('.prevPageBtn').forEach(btn => btn.disabled = isFirstPage);
        document.querySelectorAll('.nextPageBtn').forEach(btn => btn.disabled = isLastPage);
        document.querySelectorAll('.lastPageBtn').forEach(btn => btn.disabled = isLastPage);

        // 生成页码按钮HTML
        const pageNumbersHTML = generatePageNumbersHTML();
        
        // 渲染页码按钮（所有分页器）
        document.querySelectorAll('.pageNumbers').forEach(container => {
            container.innerHTML = pageNumbersHTML;
        });
    }

    function generatePageNumbersHTML() {
        let html = '';
        
        // 计算要显示的页码范围
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        // 如果当前页靠近开始，显示更多后面的页码
        if (currentPage <= 3) {
            endPage = Math.min(totalPages, 5);
        }
        // 如果当前页靠近结束，显示更多前面的页码
        if (currentPage >= totalPages - 2) {
            startPage = Math.max(1, totalPages - 4);
        }

        // 添加第一页和省略号
        if (startPage > 1) {
            html += `
                <button onclick="goToPage(1)" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100">1</button>
            `;
            if (startPage > 2) {
                html += '<span class="px-2 text-gray-500">...</span>';
            }
        }

        // 添加页码按钮
        for (let i = startPage; i <= endPage; i++) {
            const isActive = i === currentPage;
            html += `
                <button onclick="goToPage(${i})" 
                    class="px-3 py-1 border rounded ${isActive ? 'bg-black text-white border-black' : 'border-gray-300 hover:bg-gray-100'}">
                    ${i}
                </button>
            `;
        }

        // 添加省略号和最后一页
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                html += '<span class="px-2 text-gray-500">...</span>';
            }
            html += `
                <button onclick="goToPage(${totalPages})" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100">${totalPages}</button>
            `;
        }
        
        return html;
    }

    function renderAlerts() {
        const container = document.getElementById('alertsContainer');
        const noAlerts = document.getElementById('noAlerts');

        if (alerts.length === 0) {
            container.innerHTML = '';
            noAlerts.classList.remove('hidden');
            return;
        }

        noAlerts.classList.add('hidden');

        const alertTypeColors = {
            'warning': 'bg-gradient-to-r from-yellow-400 to-yellow-500',
            'error': 'bg-gradient-to-r from-red-400 to-red-500',
            'info': 'bg-gradient-to-r from-blue-400 to-blue-500',
            'critical': 'bg-gradient-to-r from-purple-400 to-purple-500'
        };

        const alertTypeIcons = {
            'warning': '<i class="fas fa-exclamation-triangle"></i>',
            'error': '<i class="fas fa-times-circle"></i>',
            'info': '<i class="fas fa-info-circle"></i>',
            'critical': '<i class="fas fa-exclamation-circle"></i>'
        };

        const alertTypeTexts = {
            'warning': '警告',
            'error': '错误', 
            'info': '信息',
            'critical': '严重'
        };

        container.innerHTML = alerts.map((a, index) => {
            const task = tasks.find(t => t.id === a.task_id);
            const taskName = task ? task.name : `任务 #${a.task_id}`;
            const sourceName = task ? (task.source_name || '未命名源') : '未知源';
            const sourceCode = task ? task.source_code : 'N/A';
            const bgColor = alertTypeColors[a.alert_type.toLowerCase()] || 'bg-gradient-to-r from-gray-400 to-gray-500';
            const icon = alertTypeIcons[a.alert_type.toLowerCase()] || '<i class="fas fa-clipboard"></i>';
            const typeText = alertTypeTexts[a.alert_type.toLowerCase()] || a.alert_type;
            const time = new Date(a.alert_time).toLocaleString('zh-CN');

            // 使用告警图片，如果没有则显示默认的告警类型图标背景
            const alertImage = a.alert_image ? 
                `<img src="/api/image/frames/${a.alert_image}" alt="Alert Image" class="w-full h-full object-cover">` :
                `<div class="w-full h-full ${bgColor} flex items-center justify-center text-white text-xl">${icon}</div>`;

            return `
            <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer border border-gray-200 hover:border-gray-300" onclick="showAlertDetail(${a.id})">
                <div class="flex">
                    <!-- 左侧图片区域（无padding，4:3比例） -->
                    <div class="flex-shrink-0 w-32 h-18 rounded-l-lg overflow-hidden bg-gray-200">
                        ${alertImage}
                    </div>
                    
                    <!-- 右侧信息区域 -->
                    <div class="flex-1 p-4 min-w-0">
                        <!-- 顶部：告警类型标签 -->
                        <div class="flex justify-start mb-3">
                            <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold text-white shadow-sm ${bgColor} transform hover:scale-105 transition-transform duration-200">
                                <span class="mr-1.5">${icon}</span>
                                ${typeText}
                            </span>
                        </div>
                        
                        <!-- 任务信息 -->
                        <div class="mb-2">
                            <h3 class="text-base font-semibold text-gray-800 truncate">${taskName}</h3>
                            <div class="text-sm text-gray-500 mt-1">
                                <span class="inline-flex items-center">
                                    <i class="fas fa-video mr-1"></i>
                                    ${sourceName} (${sourceCode})
                                </span>
                            </div>
                        </div>
                        
                        <!-- 告警消息 -->
                        <div class="mb-2">
                            <p class="text-sm text-blue-500 line-clamp-2">- ${a.alert_message}</p>
                        </div>
                        
                        <!-- 底部信息 -->
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <div class="flex items-center space-x-3">
                                <span><i class="fas fa-clock mr-1"></i>${time}</span>
                                ${a.alert_video ? '<span class="text-green-600"><i class="fas fa-video mr-1"></i>视频</span>' : ''}
                            </div>
                            <div class="text-gray-400">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    function showAlertDetail(id) {
        const alert = alerts.find(a => a.id === id);
        if (!alert) return;

        const task = tasks.find(t => t.id === alert.task_id);
        const taskName = task ? task.name : `任务 #${alert.task_id}`;
        const time = new Date(alert.alert_time).toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });

        const content = document.getElementById('alertDetailContent');
        content.innerHTML = `
            <div class="border-b pb-3">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800">${taskName}</h4>
                        <p class="text-sm text-gray-500 mt-1">
                            <i class="fas fa-video mr-1"></i>
                            ${task ? (task.source_name || '未命名源') : '未知源'} (${task ? task.source_code : 'N/A'})
                        </p>
                        <p class="text-sm text-gray-500">${time}</p>
                    </div>
                    <span class="px-3 py-1 text-sm rounded bg-${alert.alert_type === 'error' ? 'red' : alert.alert_type === 'warning' ? 'yellow' : 'blue'}-100 text-${alert.alert_type === 'error' ? 'red' : alert.alert_type === 'warning' ? 'yellow' : 'blue'}-800">
                        ${alert.alert_type}
                    </span>
                </div>
            </div>

            <div class="py-3">
                <h5 class="font-semibold text-gray-700 mb-2">告警信息</h5>
                <p class="text-gray-600 whitespace-pre-wrap">${alert.alert_message}</p>
            </div>

            ${(alert.alert_image || alert.alert_video) ? `
            <div class="py-3">
                <h5 class="font-semibold text-gray-700 mb-3">告警媒体</h5>
                <div class="grid grid-cols-1 ${(alert.alert_image && alert.alert_video) ? 'md:grid-cols-3' : ''} gap-4">
                    ${alert.alert_image ? `
                    <div class="flex flex-col">
                        <h6 class="text-sm font-medium text-gray-600 mb-2">告警图片</h6>
                        <img src="/api/image/frames/${alert.alert_image}" alt="Alert Image" class="w-full h-auto rounded border border-gray-300 shadow-sm">
                    </div>
                    ` : ''}

                    ${alert.alert_image_ori ? `
                    <div class="flex flex-col">
                        <h6 class="text-sm font-medium text-gray-600 mb-2">告警原始图片</h6>
                        <img src="/api/image/frames/${alert.alert_image_ori}" alt="Alert Image" class="w-full h-auto rounded border border-gray-300 shadow-sm">
                    </div>
                    ` : ''}
                    
                    ${alert.alert_video ? `
                    <div class="flex flex-col">
                        <h6 class="text-sm font-medium text-gray-600 mb-2">告警视频</h6>
                        <video controls class="w-full h-auto rounded border border-gray-300 shadow-sm" preload="metadata">
                            <source src="/api/video/videos/${alert.alert_video}" type="video/mp4">
                            您的浏览器不支持视频播放
                        </video>
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : ''}
        `;

        document.getElementById('alertDetailModal').classList.remove('hidden');
    }

    function closeDetailModal() {
        document.getElementById('alertDetailModal').classList.add('hidden');
    }

    // 初始化
    loadTasks().then(() => loadAlerts(1));

    // 自动刷新（每30秒）- 刷新当前页
    setInterval(() => loadAlerts(currentPage), 30000);
</script>
{% endblock %}