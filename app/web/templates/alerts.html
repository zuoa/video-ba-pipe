{% extends "base.html" %}

{% block title %}告警记录{% endblock %}
{% block page_title %}告警记录{% endblock %}
{% block page_subtitle %}实时监控和管理告警信息{% endblock %}

{% block content %}
<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
        <div class="flex items-center space-x-4">
            <div class="w-12 h-12 bg-black rounded-xl flex items-center justify-center text-white shadow-lg">
                <i class="fas fa-bell text-xl"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-800">告警列表</h3>
                <p class="text-sm text-gray-500" id="alertCount">实时监控中...</p>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <select id="taskFilter" onchange="loadAlerts(1)" class="px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all bg-white font-medium text-gray-700">
                <option value="">所有任务</option>
            </select>
            <select id="alertTypeFilter" onchange="loadAlerts(1)" class="px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all bg-white font-medium text-gray-700">
                <option value="">所有告警类型</option>
            </select>
            <button onclick="loadAlerts(currentPage)" class="btn-primary text-white px-6 py-3 rounded-lg font-medium shadow-lg flex items-center space-x-2 hover:shadow-xl">
                <i class="fas fa-sync-alt"></i>
                <span>刷新</span>
            </button>
        </div>
    </div>

    <!-- 顶部分页组件 -->
    <div id="paginationContainerTop" class="hidden mb-6 flex justify-between items-center bg-white rounded-2xl shadow-lg p-5 border border-gray-100">
        <div class="text-sm text-gray-600 font-medium flex items-center space-x-2">
            <i class="fas fa-list text-gray-700"></i>
            <span>共 <span class="totalRecords font-semibold text-gray-900">0</span> 条记录，每页</span>
            <select class="perPageSelect mx-1 px-3 py-1.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black bg-white font-medium" onchange="changePerPage()">
                <option value="12">12</option>
                <option value="20" selected>20</option>
                <option value="48">48</option>
                <option value="100">100</option>
            </select>
            <span>条</span>
        </div>
        <div class="flex items-center space-x-2">
            <button onclick="goToPage(1)" class="firstPageBtn px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-medium text-gray-700">
                首页
            </button>
            <button onclick="goToPage(currentPage - 1)" class="prevPageBtn px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-medium text-gray-700">
                上一页
            </button>
            <div class="flex items-center space-x-1 pageNumbers">
            </div>
            <button onclick="goToPage(currentPage + 1)" class="nextPageBtn px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-medium text-gray-700">
                下一页
            </button>
            <button onclick="goToPage(totalPages)" class="lastPageBtn px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-medium text-gray-700">
                末页
            </button>
        </div>
        <div class="text-sm text-gray-600 font-medium flex items-center space-x-2">
            <i class="fas fa-bookmark text-gray-700"></i>
            <span>第 <span class="currentPageDisplay font-semibold text-gray-900">1</span> / <span class="totalPagesDisplay font-semibold text-gray-900">1</span> 页</span>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="alertsContainer">
    </div>

    <div id="noAlerts" class="hidden bg-white rounded-2xl shadow-xl p-12 text-center border border-gray-100">
        <div class="w-24 h-24 mx-auto mb-6 bg-gray-100 rounded-full flex items-center justify-center">
            <i class="fas fa-bell-slash text-4xl text-gray-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">暂无告警记录</h3>
        <p class="text-gray-500">系统运行正常，没有检测到告警信息</p>
    </div>

    <!-- 底部分页组件 -->
    <div id="paginationContainerBottom" class="hidden mt-6 flex justify-between items-center bg-white rounded-2xl shadow-lg p-5 border border-gray-100">
        <div class="text-sm text-gray-600 font-medium flex items-center space-x-2">
            <i class="fas fa-list text-gray-700"></i>
            <span>共 <span class="totalRecords font-semibold text-gray-900">0</span> 条记录，每页</span>
            <select class="perPageSelect mx-1 px-3 py-1.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black bg-white font-medium" onchange="changePerPage()">
                <option value="12">12</option>
                <option value="20" selected>20</option>
                <option value="48">48</option>
                <option value="100">100</option>
            </select>
            <span>条</span>
        </div>
        <div class="flex items-center space-x-2">
            <button onclick="goToPage(1)" class="firstPageBtn px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-medium text-gray-700">
                首页
            </button>
            <button onclick="goToPage(currentPage - 1)" class="prevPageBtn px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-medium text-gray-700">
                上一页
            </button>
            <div class="flex items-center space-x-1 pageNumbers">
            </div>
            <button onclick="goToPage(currentPage + 1)" class="nextPageBtn px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-medium text-gray-700">
                下一页
            </button>
            <button onclick="goToPage(totalPages)" class="lastPageBtn px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-medium text-gray-700">
                末页
            </button>
        </div>
        <div class="text-sm text-gray-600 font-medium flex items-center space-x-2">
            <i class="fas fa-bookmark text-gray-700"></i>
            <span>第 <span class="currentPageDisplay font-semibold text-gray-900">1</span> / <span class="totalPagesDisplay font-semibold text-gray-900">1</span> 页</span>
        </div>
    </div>
</div>

<!-- 告警详情模态框 -->
<div id="alertDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
    <div class="relative top-10 mx-auto p-8 border border-gray-200 w-11/12 md:w-3/4 lg:w-2/3 shadow-2xl rounded-2xl bg-white">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-black rounded-lg flex items-center justify-center text-white">
                    <i class="fas fa-bell"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800">告警详情</h3>
                <span id="alertNavigationInfo" class="text-sm text-gray-500 font-medium"></span>
            </div>
            <div class="flex items-center space-x-2">
                <!-- 导航按钮 -->
                <button id="prevAlertBtn" onclick="navigateAlert(-1)" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg p-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed" title="上一条告警 (←)">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <button id="nextAlertBtn" onclick="navigateAlert(1)" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg p-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed" title="下一条告警 (→)">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <!-- 关闭按钮 -->
                <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg p-2 transition-all" title="关闭 (Esc)">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div id="alertDetailContent" class="space-y-6">
        </div>
    </div>
</div>

<!-- 全屏图片查看器 -->
<div id="imageViewerModal" class="hidden fixed inset-0 bg-black bg-opacity-95 overflow-hidden h-full w-full z-[60]">
    <div class="relative w-full h-full flex items-center justify-center">
        <!-- 关闭按钮 -->
        <button onclick="closeImageViewer()" class="absolute top-6 right-6 z-10 text-white hover:text-gray-300 hover:bg-white hover:bg-opacity-10 rounded-full p-3 transition-all">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        
        <!-- 缩放控制按钮 -->
        <div class="absolute top-6 left-6 z-10 flex flex-col space-y-2">
            <button onclick="zoomIn()" class="text-white hover:text-gray-300 hover:bg-white hover:bg-opacity-10 rounded-full p-3 transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
            </button>
            <button onclick="zoomOut()" class="text-white hover:text-gray-300 hover:bg-white hover:bg-opacity-10 rounded-full p-3 transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"></path>
                </svg>
            </button>
            <button onclick="resetZoom()" class="text-white hover:text-gray-300 hover:bg-white hover:bg-opacity-10 rounded-full p-3 transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
            </button>
        </div>
        
        <!-- 图片容器 -->
        <div id="imageContainer" class="relative max-w-full max-h-full overflow-hidden cursor-move select-none">
            <img id="fullscreenImage" class="block max-w-none transition-transform duration-200 ease-out" 
                 style="transform-origin: center; user-select: none; -webkit-user-drag: none;" 
                 draggable="false">
        </div>
        
        <!-- 缩放比例显示 -->
        <div id="zoomLevel" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 text-white bg-black bg-opacity-50 px-4 py-2 rounded-full text-sm font-medium">
            100%
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let alerts = [];
    let tasks = [];
    let alertTypes = [];
    let currentPage = 1;
    let perPage = 20;
    let totalPages = 1;
    let totalRecords = 0;
    let currentAlertIndex = -1; // 当前显示的告警在alerts数组中的索引

    // 图片查看器相关变量
    let currentZoom = 1;
    let minZoom = 0.1;
    let maxZoom = 10;
    let isDragging = false;
    let lastMouseX = 0;
    let lastMouseY = 0;
    let translateX = 0;
    let translateY = 0;

    // 图片查看器功能
    function openImageViewer(imageSrc) {
        const modal = document.getElementById('imageViewerModal');
        const img = document.getElementById('fullscreenImage');
        const zoomLevel = document.getElementById('zoomLevel');
        
        img.src = imageSrc;
        img.onload = function() {
            // 重置缩放和平移
            currentZoom = 1;
            translateX = 0;
            translateY = 0;
            updateImageTransform();
            updateZoomDisplay();
            
            // 显示模态框
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // 添加事件监听器
            addImageViewerEventListeners();
        };
    }

    function closeImageViewer() {
        const modal = document.getElementById('imageViewerModal');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
        
        // 移除事件监听器
        removeImageViewerEventListeners();
    }

    function zoomIn() {
        currentZoom = Math.min(currentZoom * 1.2, maxZoom);
        updateImageTransform();
        updateZoomDisplay();
    }

    function zoomOut() {
        currentZoom = Math.max(currentZoom / 1.2, minZoom);
        updateImageTransform();
        updateZoomDisplay();
    }

    function resetZoom() {
        currentZoom = 1;
        translateX = 0;
        translateY = 0;
        updateImageTransform();
        updateZoomDisplay();
    }

    function updateImageTransform() {
        const img = document.getElementById('fullscreenImage');
        img.style.transform = `scale(${currentZoom}) translate(${translateX}px, ${translateY}px)`;
    }

    function updateZoomDisplay() {
        const zoomLevel = document.getElementById('zoomLevel');
        zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
    }

    function addImageViewerEventListeners() {
        const img = document.getElementById('fullscreenImage');
        const container = document.getElementById('imageContainer');
        
        // 鼠标滚轮缩放
        container.addEventListener('wheel', handleWheel, { passive: false });
        
        // 鼠标拖拽
        container.addEventListener('mousedown', handleMouseDown);
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        
        // 键盘事件
        document.addEventListener('keydown', handleKeyDown);
        
        // 触摸事件（移动端支持）
        container.addEventListener('touchstart', handleTouchStart, { passive: false });
        container.addEventListener('touchmove', handleTouchMove, { passive: false });
        container.addEventListener('touchend', handleTouchEnd);
    }

    function removeImageViewerEventListeners() {
        const container = document.getElementById('imageContainer');
        
        container.removeEventListener('wheel', handleWheel);
        container.removeEventListener('mousedown', handleMouseDown);
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
        document.removeEventListener('keydown', handleKeyDown);
        
        container.removeEventListener('touchstart', handleTouchStart);
        container.removeEventListener('touchmove', handleTouchMove);
        container.removeEventListener('touchend', handleTouchEnd);
    }

    function handleWheel(e) {
        e.preventDefault();
        
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        const oldZoom = currentZoom;
        currentZoom = Math.max(minZoom, Math.min(maxZoom, currentZoom + delta));
        
        // 如果缩放级别改变，更新变换
        if (oldZoom !== currentZoom) {
            updateImageTransform();
            updateZoomDisplay();
        }
    }

    function handleMouseDown(e) {
        if (currentZoom > 1) {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            e.preventDefault();
        }
    }

    function handleMouseMove(e) {
        if (isDragging && currentZoom > 1) {
            const deltaX = e.clientX - lastMouseX;
            const deltaY = e.clientY - lastMouseY;
            
            translateX += deltaX / currentZoom;
            translateY += deltaY / currentZoom;
            
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            
            updateImageTransform();
            e.preventDefault();
        }
    }

    function handleMouseUp(e) {
        isDragging = false;
    }

    function handleKeyDown(e) {
        switch(e.key) {
            case 'Escape':
                closeImageViewer();
                break;
            case '+':
            case '=':
                zoomIn();
                break;
            case '-':
                zoomOut();
                break;
            case '0':
                resetZoom();
                break;
        }
    }

    // 触摸事件处理
    let lastTouchDistance = 0;
    let lastTouchX = 0;
    let lastTouchY = 0;

    function handleTouchStart(e) {
        if (e.touches.length === 1) {
            lastTouchX = e.touches[0].clientX;
            lastTouchY = e.touches[0].clientY;
            isDragging = true;
        } else if (e.touches.length === 2) {
            lastTouchDistance = getTouchDistance(e.touches[0], e.touches[1]);
            e.preventDefault();
        }
    }

    function handleTouchMove(e) {
        if (e.touches.length === 1 && isDragging && currentZoom > 1) {
            const deltaX = e.touches[0].clientX - lastTouchX;
            const deltaY = e.touches[0].clientY - lastTouchY;
            
            translateX += deltaX / currentZoom;
            translateY += deltaY / currentZoom;
            
            lastTouchX = e.touches[0].clientX;
            lastTouchY = e.touches[0].clientY;
            
            updateImageTransform();
            e.preventDefault();
        } else if (e.touches.length === 2) {
            const currentDistance = getTouchDistance(e.touches[0], e.touches[1]);
            const deltaDistance = currentDistance - lastTouchDistance;
            
            if (Math.abs(deltaDistance) > 10) {
                const delta = deltaDistance > 0 ? 0.1 : -0.1;
                const oldZoom = currentZoom;
                currentZoom = Math.max(minZoom, Math.min(maxZoom, currentZoom + delta));
                
                if (oldZoom !== currentZoom) {
                    updateImageTransform();
                    updateZoomDisplay();
                }
                
                lastTouchDistance = currentDistance;
            }
            e.preventDefault();
        }
    }

    function handleTouchEnd(e) {
        isDragging = false;
        lastTouchDistance = 0;
    }

    function getTouchDistance(touch1, touch2) {
        const dx = touch1.clientX - touch2.clientX;
        const dy = touch1.clientY - touch2.clientY;
        return Math.sqrt(dx * dx + dy * dy);
    }

    async function loadTasks() {
        try {
            tasks = await apiRequest('/api/video-sources');
            const select = document.getElementById('taskFilter');
            tasks.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.name;
                select.appendChild(option);
            });
        } catch (error) {
            showMessage('加载任务列表失败: ' + error.message, 'error');
        }
    }

    async function loadAlertTypes() {
        try {
            alertTypes = await apiRequest('/api/alert-types');
            const select = document.getElementById('alertTypeFilter');
            alertTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = getAlertTypeDisplayName(type);
                select.appendChild(option);
            });
        } catch (error) {
            showMessage('加载告警类型列表失败: ' + error.message, 'error');
        }
    }

    function getAlertTypeDisplayName(alertType) {
        const typeMap = {
            'person_detection': '人员检测',
            'phone_detection_2stage': '手机检测',
            'warning': '警告',
            'error': '错误',
            'info': '信息',
            'critical': '严重'
        };
        return typeMap[alertType] || alertType;
    }

    async function loadAlerts(page = 1) {
        currentPage = page;
        const taskId = document.getElementById('taskFilter').value;
        const alertType = document.getElementById('alertTypeFilter').value;
        let url = `/api/alerts?page=${page}&per_page=${perPage}`;
        if (taskId) {
            url += `&task_id=${taskId}`;
        }
        if (alertType) {
            url += `&alert_type=${alertType}`;
        }

        try {
            const response = await apiRequest(url);
            alerts = response.data;
            totalRecords = response.pagination.total;
            totalPages = response.pagination.total_pages;
            currentPage = response.pagination.page;
            perPage = response.pagination.per_page;
            
            const alertCount = document.getElementById('alertCount');
            alertCount.textContent = `共 ${totalRecords} 条告警`;
            
            renderAlerts();
            renderPagination();
        } catch (error) {
            showMessage('加载告警记录失败: ' + error.message, 'error');
        }
    }

    function goToPage(page) {
        if (page < 1 || page > totalPages || page === currentPage) return;
        loadAlerts(page);
    }

    function changePerPage() {
        const selects = document.querySelectorAll('.perPageSelect');
        perPage = parseInt(selects[0].value);
        loadAlerts(1); // 改变每页数量时回到第一页
    }

    function renderPagination() {
        const paginationTop = document.getElementById('paginationContainerTop');
        const paginationBottom = document.getElementById('paginationContainerBottom');
        
        // 如果没有数据，隐藏分页
        if (totalRecords === 0) {
            paginationTop.classList.add('hidden');
            paginationBottom.classList.add('hidden');
            return;
        }
        paginationTop.classList.remove('hidden');
        paginationBottom.classList.remove('hidden');

        // 更新统计信息（所有分页器）
        document.querySelectorAll('.totalRecords').forEach(el => el.textContent = totalRecords);
        document.querySelectorAll('.currentPageDisplay').forEach(el => el.textContent = currentPage);
        document.querySelectorAll('.totalPagesDisplay').forEach(el => el.textContent = totalPages);

        // 更新每页数量选择器
        document.querySelectorAll('.perPageSelect').forEach(select => {
            select.value = perPage;
        });

        // 更新按钮状态（所有分页器）
        const isFirstPage = currentPage === 1;
        const isLastPage = currentPage === totalPages;
        
        document.querySelectorAll('.firstPageBtn').forEach(btn => btn.disabled = isFirstPage);
        document.querySelectorAll('.prevPageBtn').forEach(btn => btn.disabled = isFirstPage);
        document.querySelectorAll('.nextPageBtn').forEach(btn => btn.disabled = isLastPage);
        document.querySelectorAll('.lastPageBtn').forEach(btn => btn.disabled = isLastPage);

        // 生成页码按钮HTML
        const pageNumbersHTML = generatePageNumbersHTML();
        
        // 渲染页码按钮（所有分页器）
        document.querySelectorAll('.pageNumbers').forEach(container => {
            container.innerHTML = pageNumbersHTML;
        });
    }

    function generatePageNumbersHTML() {
        let html = '';
        
        // 计算要显示的页码范围
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        // 如果当前页靠近开始，显示更多后面的页码
        if (currentPage <= 3) {
            endPage = Math.min(totalPages, 5);
        }
        // 如果当前页靠近结束，显示更多前面的页码
        if (currentPage >= totalPages - 2) {
            startPage = Math.max(1, totalPages - 4);
        }

        // 添加第一页和省略号
        if (startPage > 1) {
            html += `
                <button onclick="goToPage(1)" class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-100 transition-all font-medium text-gray-700">1</button>
            `;
            if (startPage > 2) {
                html += '<span class="px-2 text-gray-400">...</span>';
            }
        }

        // 添加页码按钮
        for (let i = startPage; i <= endPage; i++) {
            const isActive = i === currentPage;
            html += `
                <button onclick="goToPage(${i})" 
                    class="px-4 py-2 border rounded-lg font-medium transition-all ${isActive ? 'bg-black text-white border-transparent shadow-lg' : 'border-gray-200 text-gray-700 hover:bg-gray-100'}">
                    ${i}
                </button>
            `;
        }

        // 添加省略号和最后一页
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                html += '<span class="px-2 text-gray-400">...</span>';
            }
            html += `
                <button onclick="goToPage(${totalPages})" class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-100 transition-all font-medium text-gray-700">${totalPages}</button>
            `;
        }
        
        return html;
    }

    function renderAlerts() {
        const container = document.getElementById('alertsContainer');
        const noAlerts = document.getElementById('noAlerts');

        if (alerts.length === 0) {
            container.innerHTML = '';
            noAlerts.classList.remove('hidden');
            return;
        }

        noAlerts.classList.add('hidden');

        const alertTypeColors = {
            'warning': 'from-yellow-400 to-orange-500',
            'error': 'from-red-400 to-pink-500',
            'info': 'from-blue-400 to-cyan-500',
            'critical': 'from-purple-500 to-pink-500'
        };

        const alertTypeBg = {
            'warning': 'bg-gradient-to-r from-yellow-400 to-orange-500',
            'error': 'bg-gradient-to-r from-red-400 to-pink-500',
            'info': 'bg-gradient-to-r from-blue-400 to-cyan-500',
            'critical': 'bg-gradient-to-r from-purple-500 to-pink-500'
        };

        const alertTypeIcons = {
            'warning': '<i class="fas fa-exclamation-triangle"></i>',
            'error': '<i class="fas fa-times-circle"></i>',
            'info': '<i class="fas fa-info-circle"></i>',
            'critical': '<i class="fas fa-exclamation-circle"></i>'
        };

        const alertTypeTexts = {
            'warning': '警告',
            'error': '错误', 
            'info': '信息',
            'critical': '严重'
        };

        container.innerHTML = alerts.map((a, index) => {
            const task = tasks.find(t => t.id === a.task_id);
            const taskName = task ? task.name : `任务 #${a.task_id}`;
            const sourceName = task ? (task.name || '未命名源') : '未知源';
            const sourceCode = task ? task.source_code : 'N/A';
            const gradient = alertTypeColors[a.alert_type.toLowerCase()] || 'from-gray-400 to-gray-500';
            const bgGradient = alertTypeBg[a.alert_type.toLowerCase()] || 'bg-gradient-to-r from-gray-400 to-gray-500';
            const icon = alertTypeIcons[a.alert_type.toLowerCase()] || '<i class="fas fa-clipboard"></i>';
            const typeText = alertTypeTexts[a.alert_type.toLowerCase()] || a.alert_type;
            const time = new Date(a.alert_time).toLocaleString('zh-CN');

            // 使用告警图片，如果没有则显示默认的告警类型图标背景
            const alertImage = a.alert_image ? 
                `<img src="/api/image/frames/${a.alert_image}" alt="Alert Image" class="w-full h-full object-cover cursor-pointer hover:opacity-90 transition-opacity" onclick="event.stopPropagation(); openImageViewer('/api/image/frames/${a.alert_image}')">` :
                `<div class="w-full h-full ${bgGradient} flex items-center justify-center text-white text-3xl">${icon}</div>`;

            return `
            <div class="card-hover bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer border border-gray-100 overflow-hidden group" onclick="showAlertDetail(${a.id})">
                <!-- 图片区域 -->
                <div class="relative h-36 overflow-hidden bg-gradient-to-br ${gradient}">
                    ${alertImage}
                </div>
                
                <!-- 信息区域 -->
                <div class="p-5">
                    <!-- 任务信息 -->
                    <div class="mb-4">
                        <div class="flex items-center text-sm text-gray-500">
                            <div class="flex items-center px-3 py-1 bg-gray-100 rounded-lg">
                                <i class="fas fa-video mr-2 text-gray-700"></i>
                                <span class="font-medium">${sourceName}</span>
                            </div>
                            <span class="mx-2 text-gray-300">•</span>
                            <code class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-mono">${sourceCode}</code>
                        </div>
                    </div>

                    <div class="mb-4">
                        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-bold text-white bg-black bg-opacity-60 backdrop-blur-sm shadow-lg">
                            <span class="mr-1.5">${icon}</span>
                            ${typeText}
                        </span>
                    </div>
                    
                    <!-- 告警消息 -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 line-clamp-2 leading-relaxed">${a.alert_message}</p>
                    </div>
                    
                    <!-- 时间窗口检测信息 -->
                    ${a.detection_count > 1 ? `
                    <div class="mb-4">
                        <div class="flex items-center px-3 py-2 bg-blue-50 rounded-lg border border-blue-200">
                            <i class="fas fa-layer-group text-blue-600 mr-2"></i>
                            <span class="text-sm font-medium text-blue-800">时间窗口检测: ${a.detection_count} 次检测</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 底部信息 -->
                    <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                        <div class="flex items-center text-xs text-gray-500">
                            <i class="fas fa-clock mr-2 text-gray-600"></i>
                            <span class="font-medium">${time}</span>
                        </div>
                        <div class="text-gray-700 group-hover:translate-x-1 transition-transform">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    function showAlertDetail(id) {
        const alertIndex = alerts.findIndex(a => a.id === id);
        if (alertIndex === -1) return;
        
        currentAlertIndex = alertIndex;
        displayAlertDetail(alertIndex);
    }

    function displayAlertDetail(alertIndex) {
        const alert = alerts[alertIndex];
        if (!alert) return;

        const task = tasks.find(t => t.id === alert.task_id);
        const taskName = task ? task.name : `任务 #${alert.task_id}`;
        const time = new Date(alert.alert_time).toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });

        // 更新导航信息
        updateNavigationInfo(alertIndex);
        
        // 更新导航按钮状态
        updateNavigationButtons(alertIndex);

        const alertTypeColors = {
            'warning': 'from-yellow-400 to-orange-500',
            'error': 'from-red-400 to-pink-500',
            'info': 'from-blue-400 to-cyan-500',
            'critical': 'from-purple-500 to-pink-500'
        };
        const gradient = alertTypeColors[alert.alert_type.toLowerCase()] || 'from-gray-400 to-gray-500';

        const content = document.getElementById('alertDetailContent');
        content.innerHTML = `
            <div class="bg-gradient-to-br ${gradient} rounded-2xl p-6 text-white mb-6">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="text-2xl font-bold mb-3">${taskName}</h4>
                        <div class="flex flex-wrap items-center gap-3 text-sm">
                            <div class="flex items-center px-3 py-1.5 bg-white bg-opacity-20 rounded-lg backdrop-blur-sm">
                                <i class="fas fa-video mr-2"></i>
                                <span>${task ? (task.name || '未命名源') : '未知源'}</span>
                            </div>
                            <div class="flex items-center px-3 py-1.5 bg-white bg-opacity-20 rounded-lg backdrop-blur-sm">
                                <i class="fas fa-code mr-2"></i>
                                <span>${task ? task.source_code : 'N/A'}</span>
                            </div>
                            <div class="flex items-center px-3 py-1.5 bg-white bg-opacity-20 rounded-lg backdrop-blur-sm">
                                <i class="fas fa-clock mr-2"></i>
                                <span>${time}</span>
                            </div>
                        </div>
                    </div>
                    <div class="ml-4">
                        <span class="inline-flex items-center px-4 py-2 text-sm font-bold bg-white bg-opacity-30 backdrop-blur-sm rounded-xl">
                            ${alert.alert_type}
                        </span>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 rounded-2xl p-6 mb-6">
                <h5 class="font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-gray-700"></i>
                    告警信息
                </h5>
                <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">${alert.alert_message}</p>
            </div>

            ${alert.detection_count > 1 ? `
            <div class="bg-blue-50 rounded-2xl p-6 mb-6 border border-blue-200">
                <h5 class="font-bold text-blue-800 mb-4 flex items-center">
                    <i class="fas fa-layer-group mr-2 text-blue-600"></i>
                    时间窗口检测 (${alert.detection_count} 次检测)
                </h5>
                ${alert.window_stats ? `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-white rounded-lg p-3 border border-blue-200">
                        <div class="text-sm text-blue-600 font-medium">检测帧数</div>
                        <div class="text-lg font-bold text-blue-800">${JSON.parse(alert.window_stats).detection_count}/${JSON.parse(alert.window_stats).total_count}</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 border border-blue-200">
                        <div class="text-sm text-blue-600 font-medium">检测比例</div>
                        <div class="text-lg font-bold text-blue-800">${(JSON.parse(alert.window_stats).detection_ratio * 100).toFixed(1)}%</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 border border-blue-200">
                        <div class="text-sm text-blue-600 font-medium">最大连续</div>
                        <div class="text-lg font-bold text-blue-800">${JSON.parse(alert.window_stats).max_consecutive} 次</div>
                    </div>
                </div>
                ` : ''}
                ${alert.detection_images ? `
                <div class="mt-4">
                    <h6 class="text-sm font-semibold text-blue-700 mb-3">检测图片序列</h6>
                    <div class="grid grid-cols-8  gap-3">
                        ${JSON.parse(alert.detection_images).map((img, index) => {
                            const detectionTime = img.detection_time || new Date(img.timestamp * 1000).toLocaleString('zh-CN');
                            return `
                        <div class="bg-white rounded-lg p-2 border border-blue-200 hover:shadow-md transition-shadow">
                            <img src="/api/image/frames/${img.image_path}" alt="检测 ${index + 1}" 
                                 class="w-full h-24 object-cover rounded cursor-pointer hover:opacity-90 transition-opacity"
                                 onclick="openImageViewer('/api/image/frames/${img.image_path}')">
                            <div class="text-xs text-blue-600 mt-1 text-center">
                                <div class="font-medium">第${index + 1}次检测</div>
                                <div class="text-xs text-gray-500 mt-1 truncate" title="${detectionTime}">${detectionTime}</div>
                            </div>
                        </div>
                        `;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
            ` : ''}

            ${(alert.alert_image || alert.alert_video) ? `
            <div>
                <h5 class="font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-images mr-2 text-gray-700"></i>
                    告警媒体
                </h5>
                <div class="grid grid-cols-1 ${(alert.alert_image && alert.alert_video) ? 'md:grid-cols-3' : ''} gap-6">
                    ${alert.alert_image ? `
                    <div class="flex flex-col bg-gray-50 rounded-2xl p-4 border border-gray-100">
                        <h6 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-image mr-2 text-blue-500"></i>
                            告警图片
                        </h6>
                        <img src="/api/image/frames/${alert.alert_image}" alt="Alert Image" class="w-full h-auto rounded-xl border-2 border-gray-200 shadow-md hover:shadow-xl transition-shadow cursor-pointer" onclick="openImageViewer('/api/image/frames/${alert.alert_image}')">
                    </div>
                    ` : ''}

                    ${alert.alert_image_ori ? `
                    <div class="flex flex-col bg-gray-50 rounded-2xl p-4 border border-gray-100">
                        <h6 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-image mr-2 text-green-500"></i>
                            原始图片
                        </h6>
                        <img src="/api/image/frames/${alert.alert_image_ori}" alt="Alert Image" class="w-full h-auto rounded-xl border-2 border-gray-200 shadow-md hover:shadow-xl transition-shadow cursor-pointer" onclick="openImageViewer('/api/image/frames/${alert.alert_image_ori}')">
                    </div>
                    ` : ''}
                    
                    ${alert.alert_video ? `
                    <div class="flex flex-col bg-gray-50 rounded-2xl p-4 border border-gray-100">
                        <h6 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-video mr-2 text-red-500"></i>
                            告警视频
                        </h6>
                        <video controls class="w-full h-auto rounded-xl border-2 border-gray-200 shadow-md" preload="metadata">
                            <source src="/api/video/videos/${alert.alert_video}" type="video/mp4">
                            您的浏览器不支持视频播放
                        </video>
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : ''}
        `;

        document.getElementById('alertDetailModal').classList.remove('hidden');
        
        // 添加键盘事件监听器
        document.addEventListener('keydown', handleModalKeyDown);
    }

    function closeDetailModal() {
        document.getElementById('alertDetailModal').classList.add('hidden');
        
        // 移除键盘事件监听器
        document.removeEventListener('keydown', handleModalKeyDown);
        currentAlertIndex = -1;
    }

    function updateNavigationInfo(alertIndex) {
        const navInfo = document.getElementById('alertNavigationInfo');
        if (navInfo) {
            navInfo.textContent = `(${alertIndex + 1} / ${alerts.length})`;
        }
    }

    function updateNavigationButtons(alertIndex) {
        const prevBtn = document.getElementById('prevAlertBtn');
        const nextBtn = document.getElementById('nextAlertBtn');
        
        if (prevBtn) {
            prevBtn.disabled = alertIndex === 0;
        }
        if (nextBtn) {
            nextBtn.disabled = alertIndex === alerts.length - 1;
        }
    }

    function navigateAlert(direction) {
        if (currentAlertIndex === -1) return;
        
        const newIndex = currentAlertIndex + direction;
        if (newIndex >= 0 && newIndex < alerts.length) {
            currentAlertIndex = newIndex;
            displayAlertDetail(newIndex);
        }
    }

    function handleModalKeyDown(e) {
        // 只在模态框打开时处理键盘事件
        const modal = document.getElementById('alertDetailModal');
        if (modal.classList.contains('hidden')) return;
        
        switch(e.key) {
            case 'Escape':
                closeDetailModal();
                break;
            case 'ArrowLeft':
                e.preventDefault();
                navigateAlert(-1);
                break;
            case 'ArrowRight':
                e.preventDefault();
                navigateAlert(1);
                break;
        }
    }

    // 初始化
    loadTasks().then(() => {
        loadAlertTypes().then(() => loadAlerts(1));
    });

    // 自动刷新（每30秒）- 刷新当前页
    setInterval(() => loadAlerts(currentPage), 30000);
</script>
{% endblock %}